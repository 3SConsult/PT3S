<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dx &mdash; PT3S 90.14.40.0.dev1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css" />

  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html">
            
              <img src="../_static/pt3s_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functions.html">Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers.html">For Developers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">PT3S</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">Dx</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for Dx</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">shapely</span>
<span class="kn">import</span> <span class="nn">geopandas</span>
<span class="c1">#import doctest</span>
<span class="c1">#import unittest</span>
<span class="c1">#import argparse</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">pyodbc</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="c1">#import glob</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="c1">#import struct</span>
<span class="c1">#import base64</span>
<span class="c1">#import time</span>
<span class="c1">#import h5py</span>
<span class="c1">#import tables</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">sqlalchemy.ext.automap</span> <span class="kn">import</span> <span class="n">automap_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">select</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">or_</span>
<span class="c1">#from sqlalchemy import select</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">text</span>

<span class="kn">import</span> <span class="nn">inspect</span>

<span class="c1">#import warnings</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;90.14.25.0.dev1&#39;</span>

<span class="c1"># warnings.filterwarnings(&quot;ignore&quot;)</span>


<span class="c1"># ---</span>
<span class="c1"># --- PT3S Imports</span>
<span class="c1"># ---</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;PT3S&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;in MODULEFILE: __main__ Context:&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}{2:s}{3:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="s1">&#39;in MODULEFILE: Not __main__ Context: &#39;</span><span class="p">,</span> <span class="s1">&#39;__name__: &#39;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot; .&quot;</span><span class="p">))</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">PT3S</span> <span class="kn">import</span> <span class="n">Xm</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="s1">&#39;ImportError: &#39;</span><span class="p">,</span> <span class="s1">&#39;from PT3S import Xm - trying import Xm instead ... maybe pip install -e . is active ...&#39;</span><span class="p">))</span>
    <span class="kn">import</span> <span class="nn">Xm</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">PT3S</span> <span class="kn">import</span> <span class="n">dxAndMxHelperFcts</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="s1">&#39;ImportError: &#39;</span><span class="p">,</span> <span class="s1">&#39;from PT3S import dxAndMxHelperFcts - trying import dxAndMxHelperFcts instead ... maybe pip install -e . is active ...&#39;</span><span class="p">))</span>
    <span class="kn">import</span> <span class="nn">dxAndMxHelperFcts</span>

<span class="c1">#vVBEL_edges =[&#39;ROHR&#39;,&#39;VENT&#39;,&#39;FWVB&#39;,&#39;FWES&#39;,&#39;PUMP&#39;,&#39;KLAP&#39;,&#39;REGV&#39;,&#39;PREG&#39;,&#39;MREG&#39;,&#39;DPRG&#39;,&#39;PGRP&#39;]</span>
<span class="c1">#vVBEL_edgesD=[&#39;&#39;    ,&#39;DN&#39;  ,&#39;&#39;    ,&#39;DN&#39;  ,&#39;&#39;    ,&#39;DN&#39;  ,&#39;DN&#39;  ,&#39;DN&#39;  ,&#39;DN&#39;  ,&#39;DN&#39;  ,&#39;&#39;]</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">PT3S</span> <span class="kn">import</span> <span class="n">dxDecodeObjsData</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">dxDecodeObjsData</span>

<span class="k">def</span> <span class="nf">fXk</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param row: a df&#39;s row     </span>
<span class="sd">        :return: (pk,rk,tk)                </span>
<span class="sd">        &quot;&quot;&quot;</span>    
        <span class="n">xk</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">()</span><span class="o">.</span><span class="n">int</span><span class="o">&gt;&gt;</span><span class="mi">63</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">xk</span><span class="p">,</span><span class="n">xk</span><span class="p">,</span><span class="n">xk</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DxError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>


<div class="viewcode-block" id="fimportFromSIR3S"><a class="viewcode-back" href="../functions.html#Dx.fimportFromSIR3S">[docs]</a><span class="k">def</span> <span class="nf">fimportFromSIR3S</span><span class="p">(</span><span class="n">dx</span>
                    <span class="p">,</span><span class="n">OBJSrc</span>
                    <span class="p">,</span><span class="n">qSrc</span>
                    <span class="p">,</span><span class="n">objSrc</span>
                    <span class="p">,</span><span class="n">objDst</span>  
                    <span class="p">,</span><span class="n">logRows</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">):</span>       
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    work on object to import and/or decision if import at all </span>
<span class="sd">    </span>
<span class="sd">    :param dx: Dx object of Dst</span>
<span class="sd">    :type dx: Dx.Dx </span>
<span class="sd">    :param OBJSrc: </span>
<span class="sd">    :type OBJSrc: sqlalchemy.orm.decl_api.DeclarativeMeta</span>
<span class="sd">    :param qSrc: the query which delivered the objects from Src</span>
<span class="sd">    :type qSrc: sqlalchemy.orm.query.Query     </span>
<span class="sd">    :param objSrc: the object from Src </span>
<span class="sd">    :type objSrc: sqlalchemy.ext.automap         </span>
<span class="sd">    :param objDst: the object to import in Dst</span>
<span class="sd">    :type objDst: sqlalchemy.ext.automap </span>
<span class="sd">    :param logRows: decide if fcts shall generate Log-Output</span>
<span class="sd">    :type logRows: bool, optional, default=True   </span>
<span class="sd">    </span>
<span class="sd">    :return: (objDst,toImport) </span>

<span class="sd">    .. note::         </span>
<span class="sd">        At the time the function is called, objDst is already completely generated from objSrc (taking into account the specifications for e.g. fk-transfers from Templates). Whether objDst should really be imported and if so what further changes need to be made can often only be decided on a project-specific basis. Furthermore the decision may not be possible at object level alone, but all objects of the type must be taken into account, possibly even the entire model. Therefore, the Dst&#39;s dx and Src&#39;s connections are passed to make project-specific imports (via project-specific fimportFromSIR3S-functions) more flexible and powerful.</span>
<span class="sd">    &quot;&quot;&quot;</span>           
    
    <span class="n">logStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">.</span><span class="si">{1:s}</span><span class="s2">: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
    <span class="c1">#logger.debug(&quot;{0:s}{1:s}&quot;.format(logStr, &#39;Start.&#39;))</span>

    <span class="k">try</span><span class="p">:</span>
        
        <span class="n">objTYPE</span><span class="o">=</span><span class="n">OBJSrc</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">name</span>
        
        <span class="n">cols</span><span class="o">=</span><span class="n">dx</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="n">objTYPE</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        
        <span class="c1"># LogRow</span>
        <span class="n">logRow</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">objTYPE</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>            
            <span class="n">value</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">objDst</span><span class="p">,</span><span class="n">attr</span><span class="p">)</span>  
            <span class="n">logRow</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">logRow</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>        
        <span class="k">if</span> <span class="n">logRows</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">logStr</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">logRow</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">return</span><span class="p">(</span><span class="n">objDst</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
       <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
           <span class="n">logStr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
       <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>

    <span class="k">finally</span><span class="p">:</span>
       <span class="k">pass</span></div>
       <span class="c1">#logger.debug(&quot;{0:s}{1:s}&quot;.format(logStr, &#39;_Done.&#39;))</span>


<span class="k">class</span> <span class="nc">Dx</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;SIR 3S Access/SQLite to pandas DataFrames.</span>

<span class="sd">    Args:</span>
<span class="sd">        * dbFile (str): SIR 3S Access/SQLite File</span>
<span class="sd">            * wird wie angegeben gesucht</span>
<span class="sd">            * ohne Pfadangabe wird im aktuellen Verz. gesucht und (wenn das Fehl schlaegt) im uebergeordneten</span>

<span class="sd">    Attributes:</span>
<span class="sd">        * dbFile: verwendetes dbFile</span>
<span class="sd">        </span>
<span class="sd">        * QGISmodelXk: Modell-Pk des in QGIS anzuzeigenden Modells (wird von den QGIS-Views ausgewertet)</span>

<span class="sd">        * dataFrames: enthaelt alle gelesenen Tabellen und konstruierten Views</span>

<span class="sd">        * viewSets: fasst View- bzw. Tabellennamen zu Kategorien zusammen; dient zur Uebersicht bei Bedarf</span>
<span class="sd">            * allTables</span>
<span class="sd">            * pairTables</span>
<span class="sd">            * pairViews_BZ</span>
<span class="sd">            * pairViews_ROWT  </span>
<span class="sd">            * pairViews_ROWD</span>
<span class="sd">            * notPairTables</span>
<span class="sd">            * notPairTablesProbablyNotSir3sTables</span>
<span class="sd">            * notPairViews</span>
<span class="sd">            * notPairViewsProbablyNotSir3sTables</span>

<span class="sd">        * zu den Spaltennamen der Views:</span>
<span class="sd">            * grundsaetzlich die Originalnamen - aber ...</span>
<span class="sd">                * bei den _BVZ_ Views:</span>
<span class="sd">                    * :_BZ, wenn Spalten Namensgleich</span>
<span class="sd">                * Datenebenen:</span>
<span class="sd">                    * _VMBZ,_VMVARIANTE,_VMBASIS, wenn Spalten Namensgleich</span>
<span class="sd">                * CONT:</span>
<span class="sd">                    * immer _CONT</span>
<span class="sd">                * VKNO:</span>
<span class="sd">                    * immer _VKNO</span>
<span class="sd">                * VBEL:</span>
<span class="sd">                    * immer _i und _k fuer die Knotendaten</span>

<span class="sd">        * V3-Views i.e. dataFrames[&#39;V3_KNOT&#39;]</span>
<span class="sd">            * V3_KNOT: Knoten: &quot;alle&quot; Knotendaten      </span>
<span class="sd">            * V3_ROHR: Knoten: &quot;alle&quot; Rohrdaten  </span>
<span class="sd">            * V3_FWVB: Knoten: &quot;alle&quot; FWVB-Daten</span>

<span class="sd">            * V3_SWVT</span>
<span class="sd">                * 1 Zeile pro ZEIT und W; cols sind NAMEn der SWVT </span>
<span class="sd">            * V3_RSLW_SWVT</span>
<span class="sd">                * 1 Zeile pro RSLW der aktiv eine SWVT referenziert</span>

<span class="sd">            * V3_VBEL: Kanten: &quot;alle&quot; Verbindungselementdaten des hydr. Prozessmodells</span>
<span class="sd">                * Multiindex:</span>
<span class="sd">                    * OBJTYPE</span>
<span class="sd">                    * OBJID (pk)</span>
<span class="sd">                * Graph Example:</span>
<span class="sd">                    * vVbel=self.dataFrames[&#39;V3_VBEL&#39;].reset_index()</span>
<span class="sd">                    * G=nx.from_pandas_edgelist(df=vVbel, source=&#39;NAME_i&#39;, target=&#39;NAME_k&#39;, edge_attr=True) </span>
<span class="sd">                    * vKnot=self.dataFrames[&#39;V3_KNOT&#39;]</span>
<span class="sd">                    * nodeDct=vKnot.to_dict(orient=&#39;index&#39;)</span>
<span class="sd">                    * nodeDctNx={value[&#39;NAME&#39;]:value|{&#39;idx&#39;:key} for key,value in nodeDct.items()}</span>
<span class="sd">                    * nx.set_node_attributes(G,nodeDctNx)</span>
<span class="sd">                    </span>
<span class="sd">            * V3_DPKT: ausgewaehlte Daten von Datenpunkten</span>
<span class="sd">            * V3_RKNOT: Knotendaten des Signalmodells</span>
<span class="sd">                * Kn: Knotenname</span>
<span class="sd">                * OBJTYPE: der Typname des Elementes des Signalmodells z.B. RADD</span>
<span class="sd">            * V3_RRUES: </span>
<span class="sd">                * wie V_BVZ_RUES - mit folgenden zusaetzlichen Spalten:</span>
<span class="sd">                    * pk_DEF	</span>
<span class="sd">                    * IDUE_DEF	</span>
<span class="sd">                    * OBJTYPE_SRC      RXXX-Objekttyp der das Signal definiert welches die Ue repraesentiert	                    </span>
<span class="sd">                    * Kn_SR            Signal fuer das die Ue ein Alias ist (KA des RXXX)</span>
<span class="sd">                    * NAME_CONT_SRC    Block in dem das Signal definiert wird (das RXXX-Element liegt)</span>

<span class="sd">            * V3_RVBEL: Kantendaten des Signalmodells</span>
<span class="sd">                * Multiindex:</span>
<span class="sd">                    * OBJTYPE_i</span>
<span class="sd">                    * OBJTYPE_k                </span>
<span class="sd">                * RUES-RXXX sind in den Spalten &#39;OBJTYPE_i&#39;,&#39;OBJID_i&#39;,&#39;Kn_i&#39;,&#39;KnExt_i&#39;,&#39;NAME_CONT_i&#39; durch die RUES-Quelle ersetzt</span>
<span class="sd">                * Graph Example:</span>
<span class="sd">                    * vRVbel=self.dataFrames[&#39;V3_RVBEL&#39;].reset_index()</span>
<span class="sd">                    * GSig=nx.from_pandas_edgelist(df=vRVbel, source=&#39;Kn_i&#39;, target=&#39;Kn_k&#39;, edge_attr=True, create_using=nx.DiGraph())</span>
<span class="sd">                    * nodeDct=vRknot.to_dict(orient=&#39;index&#39;)</span>
<span class="sd">                    * nodeDctNx={value[&#39;Kn&#39;]:value|{&#39;idx&#39;:key} for key,value in nodeDct.items()}</span>
<span class="sd">                    * nx.set_node_attributes(GSig,nodeDctNx)</span>
<span class="sd">                                    </span>
<span class="sd">        * viewSets[&#39;pairViews_BZ&#39;]:</span>
<span class="sd">            * [&#39;V_BVZ_ALLG&#39;</span>
<span class="sd">            ...</span>
<span class="sd">            *, &#39;V_BVZ_WIND&#39;]</span>
<span class="sd">        * viewSets[&#39;pairViews_ROWS&#39;]:</span>
<span class="sd">            * [&#39;V_BVZ_ANTE&#39;</span>
<span class="sd">            ...</span>
<span class="sd">            *, &#39;V_BVZ_ZEP1&#39;, &#39;V_BVZ_ZEP2&#39;]</span>
<span class="sd">        * viewSets[&#39;pairViews_ROWT&#39;]:</span>
<span class="sd">            * [&#39;V_BVZ_LFKT&#39;</span>
<span class="sd">            ...</span>
<span class="sd">            *, &#39;V_BVZ_RCPL&#39; # da RCPL_ROWT existiert &quot;landet&quot; RCPL bei den ROWTs</span>
<span class="sd">            ...</span>
<span class="sd">            , &#39;V_BVZ_WTTR&#39;]</span>
<span class="sd">            * enthalten alle Zeiten</span>
<span class="sd">            * Spalte lfdNrZEIT beginnt mit 1 fuer die chronologisch 1. Zeit (na_position=&#39;first&#39;)</span>
<span class="sd">        * viewSets[&#39;pairViews_ROWD&#39;]:</span>
<span class="sd">            * [&#39;V_BVZ_DTRO&#39;]</span>
<span class="sd">        * viewSets[&#39;notPairViews&#39;]:</span>
<span class="sd">            * [&#39;V_AB_DEF&#39;, &#39;V_AGSN&#39;, &#39;V_ARRW&#39;, &#39;V_ATMO&#39;</span>
<span class="sd">            *, &#39;V_BENUTZER&#39;, &#39;V_BREF&#39;</span>
<span class="sd">            *, &#39;V_CIRC&#39;, &#39;V_CONT&#39;, &#39;V_CRGL&#39;</span>
<span class="sd">            *, &#39;V_DATENEBENE&#39;, &#39;V_DPGR_DPKT&#39;, &#39;V_DPKT&#39;, &#39;V_DRNP&#39;</span>
<span class="sd">            *, &#39;V_ELEMENTQUERY&#39;</span>
<span class="sd">            *, &#39;V_FSTF&#39;, &#39;V_FWBZ&#39;</span>
<span class="sd">            *, &#39;V_GKMP&#39;, &#39;V_GMIX&#39;, &#39;V_GRAV&#39;, &#39;V_GTXT&#39;</span>
<span class="sd">            *, &#39;V_HAUS&#39;</span>
<span class="sd">            *, &#39;V_LAYR&#39;, &#39;V_LTGR&#39;</span>
<span class="sd">            *, &#39;V_MODELL&#39;, &#39;V_MWKA&#39;</span>
<span class="sd">            *, &#39;V_NRCV&#39;</span>
<span class="sd">            *, &#39;V_OVAL&#39;</span>
<span class="sd">            *, &#39;V_PARV&#39;, &#39;V_PGPR&#39;, &#39;V_PLYG&#39;, &#39;V_POLY&#39;, &#39;V_PROZESSE&#39;, &#39;V_PZON&#39;</span>
<span class="sd">            *, &#39;V_RCON&#39;, &#39;V_RECT&#39;, &#39;V_REGP&#39;, &#39;V_RMES_DPTS&#39;, &#39;V_ROHR_VRTX&#39;, &#39;V_RPFL&#39;, &#39;V_RRCT&#39;</span>
<span class="sd">            *, &#39;V_SIRGRAF&#39;, &#39;V_SOKO&#39;, &#39;V_SPLZ&#39;, &#39;V_STRASSE&#39;, &#39;V_SYSTEMKONFIG&#39;</span>
<span class="sd">            *, &#39;V_TIMD&#39;, &#39;V_TRVA&#39;</span>
<span class="sd">            *, &#39;V_UTMP&#39;</span>
<span class="sd">            *, &#39;V_VARA&#39;, &#39;V_VARA_CSIT&#39;, &#39;V_VARA_WSIT&#39;, &#39;V_VERB&#39;, &#39;V_VKNO&#39;, &#39;V_VRCT&#39;</span>
<span class="sd">            *, &#39;V_WBLZ&#39;]</span>
<span class="sd">    Raises:</span>
<span class="sd">        DxError</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbFile</span><span class="p">):</span>

        <span class="n">logStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">.</span><span class="si">{1:s}</span><span class="s2">: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;Start.#########&#39;</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dbFile</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">dbFile</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">dbFile: </span><span class="si">{:s}</span><span class="s2">: Not writable.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="n">dbFile</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">dbFile</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">):</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">dbFile: </span><span class="si">{:s}</span><span class="s2">: Not readable!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">logStr</span><span class="p">,</span> <span class="n">dbFile</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">DxError</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># pruefen, ob dbFile im uebergeordneten Verzeichnis existiert</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">dbFile: </span><span class="si">{:s}</span><span class="s2">: Not existing! Suche im uebergeordneten Verz. ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">logStr</span><span class="p">,</span> <span class="n">dbFile</span><span class="p">))</span>

                <span class="n">dbFileAlt</span> <span class="o">=</span> <span class="n">dbFile</span>
                <span class="n">dbFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="n">dbFileAlt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dbFile</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">dbFile</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">dbFile: </span><span class="si">{:s}</span><span class="s2">: Not writable.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="n">dbFile</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">dbFile</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">):</span>
                            <span class="k">pass</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">dbFile: </span><span class="si">{:s}</span><span class="s2">: Not readable!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">logStr</span><span class="p">,</span> <span class="n">dbFile</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="n">DxError</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">dbFile: </span><span class="si">{:s}</span><span class="s2">: Not existing!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">logStr</span><span class="p">,</span> <span class="n">dbFile</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">DxError</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>

            <span class="c1"># das dbFile existiert und ist lesbar</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">dbFile (abspath): </span><span class="si">{:s}</span><span class="s2"> exists readable ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">logStr</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">dbFile</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;wolters&#39;</span><span class="p">,</span><span class="s1">&#39;aUserName&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;jablonski&#39;</span><span class="p">,</span><span class="s1">&#39;aUserName&#39;</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dbFile</span> <span class="o">=</span> <span class="n">dbFile</span>

            <span class="c1"># Access oder SQLite</span>
            <span class="n">dummy</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">dbFile</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.mdb&#39;</span><span class="p">:</span>
                <span class="n">Driver</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pyodbc</span><span class="o">.</span><span class="n">drivers</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
                    <span class="s1">&#39;Microsoft Access Driver&#39;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">Driver</span> <span class="o">==</span> <span class="p">[]:</span>
                    <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}{:s}</span><span class="s2">: No Microsoft Access Driver!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">logStr</span><span class="p">,</span> <span class="n">dbFile</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">DxError</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>

                <span class="c1"># ein Treiber ist installiert</span>
                <span class="n">conStr</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">r</span><span class="s1">&#39;DRIVER={&#39;</span><span class="o">+</span><span class="n">Driver</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;};&#39;</span>
                    <span class="sa">r</span><span class="s1">&#39;DBQ=&#39;</span><span class="o">+</span><span class="n">dbFile</span><span class="o">+</span><span class="s1">&#39;;&#39;</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">conStr: </span><span class="si">{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="n">conStr</span><span class="p">))</span>

                <span class="c1"># Verbindung ...</span>
                <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">sqlalchemy.engine</span> <span class="kn">import</span> <span class="n">URL</span>
                    <span class="n">connection_url</span> <span class="o">=</span> <span class="n">URL</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                        <span class="s2">&quot;access+pyodbc&quot;</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;odbc_connect&quot;</span><span class="p">:</span> <span class="n">conStr</span><span class="p">})</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">connection_url type: </span><span class="si">{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">logStr</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">connection_url</span><span class="p">))))</span>
                    <span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
                    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">connection_url</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">engine type: </span><span class="si">{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">logStr</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">engine</span><span class="p">))))</span>
                    <span class="n">con</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">con type: </span><span class="si">{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">logStr</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">con</span><span class="p">))))</span>

                    <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">inspect</span>
                        <span class="n">insp</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
                        <span class="n">tableNames</span> <span class="o">=</span> <span class="n">insp</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">()</span>  <span class="c1"># insp.get_view_names()</span>
                        <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span>
                        <span class="n">tableNames</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">table_names</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">con</span> <span class="o">=</span> <span class="n">pyodbc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">conStr</span><span class="p">)</span>
                    <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                    <span class="c1"># all Tables in DB</span>
                    <span class="n">tableNames</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">table_info</span><span class="o">.</span><span class="n">table_name</span> <span class="k">for</span> <span class="n">table_info</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">tables</span><span class="p">(</span><span class="n">tableType</span><span class="o">=</span><span class="s1">&#39;TABLE&#39;</span><span class="p">)]</span>
                    <span class="n">viewNames</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">table_info</span><span class="o">.</span><span class="n">table_name</span> <span class="k">for</span> <span class="n">table_info</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">tables</span><span class="p">(</span><span class="n">tableType</span><span class="o">=</span><span class="s1">&#39;VIEW&#39;</span><span class="p">)]</span>

            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.db3&#39;</span><span class="p">:</span>
                <span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbFile</span><span class="p">)</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="s2">&quot;SELECT name FROM sqlite_master WHERE type=&#39;table&#39;;&quot;</span><span class="p">)</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                <span class="n">tableNames</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]</span>

                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="s2">&quot;SELECT name FROM sqlite_master WHERE type=&#39;view&#39;;&quot;</span><span class="p">)</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                <span class="n">viewNames</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">dbFile: </span><span class="si">{:s}</span><span class="s2"> ext: </span><span class="si">{:s}</span><span class="s2">: unbekannter DB-Typ (.mdb und .db3 sind zulaessig)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">logStr</span><span class="p">,</span> <span class="n">dbFile</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">DxError</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">tableNames: </span><span class="si">{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">logStr</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tableNames</span><span class="p">)))</span>
            <span class="n">allTables</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tableNames</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">viewNames: </span><span class="si">{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">logStr</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">viewNames</span><span class="p">)))</span>
            <span class="c1">#allViews = set(viewNames)</span>

            <span class="c1"># pandas DataFrames</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Mengen von Typen von Tabellen und Views</span>
            <span class="n">pairTables</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">pairViews</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">pairViews_BZ</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">pairViews_ROWS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">pairViews_ROWT</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">pairViews_ROWD</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="c1"># SIR 3S Grundtabellen und -views lesen</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dfViewModelle</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">fHelperSqlText</span><span class="p">(</span>
                    <span class="s1">&#39;select * from VIEW_MODELLE&#39;</span><span class="p">),</span> <span class="n">con</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;VIEW_MODELLE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfViewModelle</span>
            <span class="k">except</span> <span class="n">pd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">logStr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">DxError</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">dfCONT</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">fHelperSqlText</span><span class="p">(</span><span class="s1">&#39;select * from CONT&#39;</span><span class="p">),</span> <span class="n">con</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">pd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">logStr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">DxError</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>

            <span class="c1"># try:</span>
            <span class="c1">#     dfKNOT = pd.read_sql(fHelperSqlText(&#39;select * from KNOT&#39;), con)</span>
            <span class="c1"># except pd.io.sql.DatabaseError as e:</span>
            <span class="c1">#     logStrFinal = &quot;{:s}Exception: Line: {:d}: {!s:s}: {:s}&quot;.format(</span>
            <span class="c1">#         logStr, sys.exc_info()[-1].tb_lineno, type(e), str(e))</span>
            <span class="c1">#     logger.error(logStrFinal)</span>
            <span class="c1">#     raise DxError(logStrFinal)</span>

            <span class="c1"># Paare</span>
            <span class="k">for</span> <span class="n">pairType</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;_BZ&#39;</span><span class="p">,</span> <span class="s1">&#39;_ROWS&#39;</span><span class="p">,</span> <span class="s1">&#39;_ROWT&#39;</span><span class="p">,</span> <span class="s1">&#39;_ROWD&#39;</span><span class="p">]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">pair-tables: pairType: </span><span class="si">{1:s}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="n">pairType</span><span class="p">))</span>
                <span class="c1">#tablePairsBVBZ=[(re.search(&#39;(?P&lt;BV&gt;[A-Z,1,2]+)(&#39;+pairType+&#39;)$&#39;,table_info.table_name).group(&#39;BV&#39;),table_info.table_name) for table_info in cur.tables(tableType=&#39;TABLE&#39;) if re.search(&#39;(?P&lt;BV&gt;[A-Z,1,2]+)(&#39;+pairType+&#39;)$&#39;,table_info.table_name) != None]</span>
                <span class="n">tablePairsBVBZ</span> <span class="o">=</span> <span class="p">[(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?P&lt;BV&gt;[A-Z,1,2,_]+)(&#39;</span><span class="o">+</span><span class="n">pairType</span><span class="o">+</span><span class="s1">&#39;)$&#39;</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;BV&#39;</span><span class="p">),</span> <span class="n">table_name</span><span class="p">)</span>
                                  <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">tableNames</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?P&lt;BV&gt;[A-Z,1,2]+)(&#39;</span><span class="o">+</span><span class="n">pairType</span><span class="o">+</span><span class="s1">&#39;)$&#39;</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">]</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">BV</span><span class="p">,</span> <span class="n">BZ</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tablePairsBVBZ</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">BV</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tableNames</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">BV: </span><span class="si">{1:s}</span><span class="s2">: BV-Tabelle gibt es nicht (BZ: </span><span class="si">{2:s}</span><span class="s2">). Falsche Paar-Ermittlung? Weiter. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="n">BV</span><span class="p">,</span><span class="n">BZ</span><span class="p">))</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">BZ</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tableNames</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">BZ: </span><span class="si">{1:s}</span><span class="s2">: BZ-Tabelle gibt es nicht (BZ: </span><span class="si">{2:s}</span><span class="s2">). Falsche Paar-Ermittlung? Weiter. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="n">BZ</span><span class="p">,</span> <span class="n">BV</span><span class="p">))</span>
                        <span class="k">continue</span>

                    <span class="c1">#if BZ == &#39;PGRP_PUMP_BZ&#39;:  # BV: PUMP BVZ: PGRP_PUMP_BZ V: V_PUMP - Falsch!; wird unten ergaenzt</span>
                    <span class="c1">#    continue</span>

                    <span class="c1"># TabellenNamen in entspr. Mengen abspeichern</span>
                    <span class="n">pairTables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BV</span><span class="p">)</span>
                    <span class="n">pairTables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BZ</span><span class="p">)</span>

                    <span class="c1"># VName</span>
                    <span class="n">VName</span> <span class="o">=</span> <span class="s1">&#39;V_BVZ_&#39;</span><span class="o">+</span><span class="n">BV</span>

                    <span class="n">dfBV</span><span class="p">,</span> <span class="n">dfBZ</span><span class="p">,</span> <span class="n">dfBVZ</span> <span class="o">=</span> <span class="n">fHelper</span><span class="p">(</span>
                        <span class="n">con</span><span class="p">,</span> <span class="n">BV</span><span class="p">,</span> <span class="n">BZ</span><span class="p">,</span> <span class="n">dfViewModelle</span><span class="p">,</span> <span class="n">dfCONT</span><span class="p">,</span> <span class="n">pairType</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>

                    <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">dfBVZ</span><span class="o">.</span><span class="n">shape</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">BV: </span><span class="si">{1:12s}</span><span class="s2"> BVZ: </span><span class="si">{2:12s}</span><span class="s2"> V: </span><span class="si">{3:15s}</span><span class="s2"> constructed with </span><span class="si">{4:8d}</span><span class="s2"> rows and </span><span class="si">{5:3d}</span><span class="s2"> cols.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">logStr</span><span class="p">,</span> <span class="n">BV</span><span class="p">,</span> <span class="n">BZ</span><span class="p">,</span> <span class="n">VName</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="n">BV</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfBV</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="n">BZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfBZ</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="n">VName</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfBVZ</span>

                    <span class="c1"># ViewName in entspr. Menge abspeichern</span>
                    <span class="n">pairViews</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">VName</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pairType</span> <span class="o">==</span> <span class="s1">&#39;_BZ&#39;</span><span class="p">:</span>
                        <span class="n">pairViews_BZ</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">VName</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">pairType</span> <span class="o">==</span> <span class="s1">&#39;_ROWS&#39;</span><span class="p">:</span>
                        <span class="n">pairViews_ROWS</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">VName</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">pairType</span> <span class="o">==</span> <span class="s1">&#39;_ROWT&#39;</span><span class="p">:</span>
                        <span class="n">pairViews_ROWT</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">VName</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">pairType</span> <span class="o">==</span> <span class="s1">&#39;_ROWD&#39;</span><span class="p">:</span>
                        <span class="n">pairViews_ROWD</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">VName</span><span class="p">)</span>

            <span class="c1"># BVZ-Paare Nachzuegler</span>
            <span class="c1"># for (BV, BZ) in [(&#39;PGRP_PUMP&#39;, &#39;PGRP_PUMP_BZ&#39;), (&#39;RMES_DPTS&#39;, &#39;RMES_DPTS_BZ&#39;)]:</span>

            <span class="c1">#     dfBV, dfBZ, dfBVZ = fHelper(</span>
            <span class="c1">#         con, BV, BZ, dfViewModelle, dfCONT, &#39;_BZ&#39;, ext)</span>

            <span class="c1">#     VName = &#39;V_BVZ_&#39;+BV</span>
            <span class="c1">#     self.dataFrames[VName] = dfBVZ</span>

            <span class="c1">#     rows, cols = dfBVZ.shape</span>
            <span class="c1">#     logger.debug(&quot;{0:s}BV: {1:s} BVZ: {2:s} V: {3:s} fertig mit {4:d} Zeilen und {5:d} Spalten.&quot;.format(</span>
            <span class="c1">#         logStr, BV, BZ, VName, rows, cols))</span>

            <span class="c1">#     pairTables.add(BV)</span>
            <span class="c1">#     pairTables.add(BZ)</span>

            <span class="c1">#     pairViews.add(VName)</span>
            <span class="c1">#     pairViews_BZ.add(VName)</span>

            <span class="c1"># Nicht-Paare</span>
            <span class="n">notInPairTables</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">allTables</span><span class="o">-</span><span class="n">pairTables</span><span class="p">)</span>
            <span class="n">notInPairTablesW</span> <span class="o">=</span> <span class="p">[</span>  <span class="c1"># W: &quot;Sollwert&quot;; erwartete SIR 3S Tabellen, die nicht Paare sind</span>
                <span class="c1"># ,&#39;DPKT&#39; # ab 90-12 ein Paar</span>
                <span class="s1">&#39;AB_DEF&#39;</span><span class="p">,</span> <span class="s1">&#39;AGSN&#39;</span><span class="p">,</span> <span class="s1">&#39;ARRW&#39;</span><span class="p">,</span> <span class="s1">&#39;ATMO&#39;</span><span class="p">,</span> <span class="s1">&#39;BENUTZER&#39;</span><span class="p">,</span> <span class="s1">&#39;BREF&#39;</span><span class="p">,</span> <span class="s1">&#39;CIRC&#39;</span><span class="p">,</span> <span class="s1">&#39;CONT&#39;</span><span class="p">,</span> <span class="s1">&#39;CRGL&#39;</span><span class="p">,</span> <span class="s1">&#39;DATENEBENE&#39;</span><span class="p">,</span> <span class="s1">&#39;DPGR_DPKT&#39;</span><span class="p">,</span> <span class="s1">&#39;DRNP&#39;</span><span class="p">,</span> <span class="s1">&#39;ELEMENTQUERY&#39;</span><span class="p">,</span> <span class="s1">&#39;FSTF&#39;</span><span class="p">,</span> <span class="s1">&#39;FWBZ&#39;</span><span class="p">,</span> <span class="s1">&#39;GEOMETRY_COLUMNS&#39;</span>  <span class="c1"># 90-12</span>
                <span class="c1"># ,&#39;MWKA&#39; # nicht 90-12</span>
                <span class="c1"># ,&#39;RMES_DPTS&#39;#, &#39;RMES_DPTS_BZ&#39;</span>
                <span class="c1"># , &#39;VARA_CSIT&#39;, &#39;VARA_WSIT&#39;</span>
                <span class="p">,</span> <span class="s1">&#39;GKMP&#39;</span><span class="p">,</span> <span class="s1">&#39;GMIX&#39;</span><span class="p">,</span> <span class="s1">&#39;GRAV&#39;</span><span class="p">,</span> <span class="s1">&#39;GTXT&#39;</span><span class="p">,</span> <span class="s1">&#39;HAUS&#39;</span><span class="p">,</span> <span class="s1">&#39;LAYR&#39;</span><span class="p">,</span> <span class="s1">&#39;LTGR&#39;</span><span class="p">,</span> <span class="s1">&#39;MODELL&#39;</span><span class="p">,</span> <span class="s1">&#39;NRCV&#39;</span><span class="p">,</span> <span class="s1">&#39;OVAL&#39;</span><span class="p">,</span> <span class="s1">&#39;PARV&#39;</span><span class="p">,</span> <span class="s1">&#39;PGPR&#39;</span><span class="p">,</span> <span class="s1">&#39;PLYG&#39;</span><span class="p">,</span> <span class="s1">&#39;POLY&#39;</span><span class="p">,</span> <span class="s1">&#39;PROZESSE&#39;</span><span class="p">,</span> <span class="s1">&#39;PZON&#39;</span><span class="p">,</span> <span class="s1">&#39;RCON&#39;</span><span class="p">,</span> <span class="s1">&#39;RECT&#39;</span><span class="p">,</span> <span class="s1">&#39;REGP&#39;</span><span class="p">,</span> <span class="s1">&#39;ROHR_VRTX&#39;</span><span class="p">,</span> <span class="s1">&#39;RPFL&#39;</span><span class="p">,</span> <span class="s1">&#39;RRCT&#39;</span><span class="p">,</span> <span class="s1">&#39;SIRGRAF&#39;</span><span class="p">,</span> <span class="s1">&#39;SOKO&#39;</span><span class="p">,</span> <span class="s1">&#39;SPLZ&#39;</span><span class="p">,</span> <span class="s1">&#39;STRASSE&#39;</span><span class="p">,</span> <span class="s1">&#39;SYSTEMKONFIG&#39;</span><span class="p">,</span> <span class="s1">&#39;TIMD&#39;</span><span class="p">,</span> <span class="s1">&#39;TRVA&#39;</span><span class="p">,</span> <span class="s1">&#39;UTMP&#39;</span><span class="p">,</span> <span class="s1">&#39;VARA&#39;</span><span class="p">,</span> <span class="s1">&#39;VERB&#39;</span><span class="p">,</span> <span class="s1">&#39;VKNO&#39;</span><span class="p">,</span> <span class="s1">&#39;VRCT&#39;</span><span class="p">,</span> <span class="s1">&#39;WBLZ&#39;</span><span class="p">]</span>

            <span class="c1"># erwartete SIR 3S Tabellen, die nicht Paare sind</span>
            <span class="n">notPairTables</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">notPairViews</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">tables which are not pair-tables:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">))</span>            
            
            <span class="k">for</span> <span class="n">tableName</span> <span class="ow">in</span> <span class="n">notInPairTablesW</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">tableName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tableNames</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">tableName: </span><span class="si">{1:s}</span><span class="s2">: Tabelle gibt es nicht - falsche Annahme in diesem Modul bzgl. der existierenden SIR 3S Tabellen? Weiter. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="n">tableName</span><span class="p">))</span>
                    <span class="k">continue</span>

                <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;select * from &#39;</span><span class="o">+</span><span class="n">tableName</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">fHelperSqlText</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">ext</span><span class="p">),</span> <span class="n">con</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="n">tableName</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
                    <span class="n">notPairTables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tableName</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>  <span class="c1"># pd.io.sql.DatabaseError as e:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">sql: </span><span class="si">{1:s}</span><span class="s2">: Fehler?! Weiter. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="n">sql</span><span class="p">))</span>
                    <span class="k">continue</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">fHelperCONTetc</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">tableName</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">dfViewModelle</span><span class="p">,</span> <span class="n">dfCONT</span><span class="p">,</span>
                                    <span class="s1">&#39;erwartete SIR 3S Tabellen, die nicht Paare sind&#39;</span><span class="p">)</span>

                <span class="n">VName</span> <span class="o">=</span> <span class="s1">&#39;V_&#39;</span><span class="o">+</span><span class="n">tableName</span>
                
                <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">table: </span><span class="si">{1:16s}</span><span class="s2"> V: </span><span class="si">{2:20s}</span><span class="s2"> constructed with </span><span class="si">{3:8d}</span><span class="s2"> rows and </span><span class="si">{4:3d}</span><span class="s2"> cols.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">logStr</span><span class="p">,</span> <span class="n">tableName</span><span class="p">,</span> <span class="n">VName</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>                
                
                
                
                <span class="c1">#logger.debug(&quot;{0:s}V: {1:s}&quot;.format(logStr, VName))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="n">VName</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
                <span class="n">notPairViews</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">VName</span><span class="p">)</span>

            <span class="c1"># unerwartete Tabellen</span>
            <span class="n">notPairViewsProbablyNotSir3sTables</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">notPairTablesProbablyNotSir3sTables</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">tableName</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">notInPairTables</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">notInPairTablesW</span><span class="p">):</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">tableName: </span><span class="si">{1:s}</span><span class="s2">: Tabelle keine SIR 3S Tabelle aus Sicht dieses Moduls. Trotzdem lesen. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">logStr</span><span class="p">,</span> <span class="n">tableName</span><span class="p">))</span>

                <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;select * from &#39;</span><span class="o">+</span><span class="n">tableName</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">fHelperSqlText</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">ext</span><span class="p">),</span> <span class="n">con</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="n">tableName</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
                    <span class="n">notPairTablesProbablyNotSir3sTables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tableName</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">pd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">DatabaseError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">sql: </span><span class="si">{1:s}</span><span class="s2">: Fehler?! Weiter. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="n">sql</span><span class="p">))</span>
                    <span class="k">continue</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">fHelperCONTetc</span><span class="p">(</span>
                    <span class="n">df</span><span class="p">,</span> <span class="n">tableName</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">dfViewModelle</span><span class="p">,</span> <span class="n">dfCONT</span><span class="p">,</span> <span class="s1">&#39;unerwartete Tabellen&#39;</span><span class="p">)</span>

                <span class="n">VName</span> <span class="o">=</span> <span class="s1">&#39;V_&#39;</span><span class="o">+</span><span class="n">tableName</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">V: </span><span class="si">{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="n">VName</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="n">VName</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
                <span class="n">notPairViewsProbablyNotSir3sTables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">VName</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">viewSets</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">viewSets</span><span class="p">[</span><span class="s1">&#39;allTables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">allTables</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewSets</span><span class="p">[</span><span class="s1">&#39;pairTables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pairTables</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">viewSets</span><span class="p">[</span><span class="s1">&#39;pairViews&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pairViews</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewSets</span><span class="p">[</span><span class="s1">&#39;pairViews_BZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pairViews_BZ</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewSets</span><span class="p">[</span><span class="s1">&#39;pairViews_ROWS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pairViews_ROWS</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewSets</span><span class="p">[</span><span class="s1">&#39;pairViews_ROWT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pairViews_ROWT</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewSets</span><span class="p">[</span><span class="s1">&#39;pairViews_ROWD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pairViews_ROWD</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">viewSets</span><span class="p">[</span><span class="s1">&#39;notPairTables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">notPairTables</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewSets</span><span class="p">[</span><span class="s1">&#39;notPairTablesProbablyNotSir3sTables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="n">notPairTablesProbablyNotSir3sTables</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewSets</span><span class="p">[</span><span class="s1">&#39;notPairViews&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">notPairViews</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewSets</span><span class="p">[</span><span class="s1">&#39;notPairViewsProbablyNotSir3sTables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="n">notPairViewsProbablyNotSir3sTables</span><span class="p">)</span>

            <span class="n">con</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  
            <span class="c1"># #############################################################</span>
            <span class="c1"># #############################################################</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfLAYR</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dfLAYR</span><span class="p">()</span>    

            <span class="c1"># #############################################################</span>
            <span class="c1"># #############################################################</span>

            <span class="c1"># V_BVZ_ROHR um u.a. DN erweitern</span>
            <span class="c1"># #############################################################</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">expanding </span><span class="si">{1:s}</span><span class="s2"> with NAME_DTRO, DN, DI, DA, S, KT, PN, Am2, Vm3 ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;V_BVZ_ROHR&#39;</span><span class="p">))</span>
            
            <span class="n">dfSrc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_BVZ_ROHR&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;pk_BZ&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_BVZ_DTRO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfSrc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_BVZ_DTRO&#39;</span><span class="p">],</span>
                              <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkDTRO_ROWD&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;pk_BZ&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_DTRO&#39;</span><span class="p">))</span>                
                <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfSrc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_BVZ_DTRO&#39;</span><span class="p">],</span>
                              <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkDTRO_ROWD&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;tk_BZ&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_DTRO&#39;</span><span class="p">))</span>
                
                <span class="k">if</span> <span class="n">df1</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="n">df2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">df1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">df</span><span class="o">=</span><span class="n">df2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span><span class="o">=</span><span class="n">df1</span>
                    
            <span class="k">elif</span> <span class="s1">&#39;pk_BV&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_BVZ_DTRO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfSrc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_BVZ_DTRO&#39;</span><span class="p">],</span>
                              <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkDTRO_ROWD&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;pk_BV&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_DTRO&#39;</span><span class="p">))</span>
                <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfSrc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_BVZ_DTRO&#39;</span><span class="p">],</span>
                              <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkDTRO_ROWD&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;tk_BV&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_DTRO&#39;</span><span class="p">))</span>
                
                <span class="k">if</span> <span class="n">df1</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="n">df2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">df1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">df</span><span class="o">=</span><span class="n">df2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span><span class="o">=</span><span class="n">df1</span>
                    
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">dfSrc</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span>
            <span class="p">)</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;DN&#39;</span><span class="p">,</span> <span class="s1">&#39;DI&#39;</span><span class="p">,</span> <span class="s1">&#39;DA&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;KT&#39;</span><span class="p">,</span> <span class="s1">&#39;PN&#39;</span><span class="p">])</span>
            <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;NAME_DTRO&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Am2&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;DI&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Vm3&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Am2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">]</span> <span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">logStr</span><span class="si">}</span><span class="s2">expanding V_BVZ_ROHR: rows before: </span><span class="si">{</span><span class="n">dfSrc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> rows now: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        
            <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_BVZ_ROHR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

            <span class="c1"># weitere Erweiterungen zu V3_ROHR</span>
            <span class="c1"># #############################################################</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">V3_ROHR: expanding </span><span class="si">{1:s}</span><span class="s2"> with  NAME_LTGR, NAME_STRASSE, tk_i, NAME_i, tk_k, NAME_k ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;V_BVZ_ROHR&#39;</span><span class="p">))</span>            
                                
            <span class="n">extV</span> <span class="o">=</span> <span class="n">df</span>

            <span class="k">for</span> <span class="n">dfRefStr</span><span class="p">,</span> <span class="n">fkRefStr</span><span class="p">,</span> <span class="n">refName</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;LTGR&#39;</span><span class="p">,</span> <span class="s1">&#39;STRASSE&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;fkLTGR&#39;</span><span class="p">,</span> <span class="s1">&#39;fkSTRASSE&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;LTGR&#39;</span><span class="p">,</span> <span class="s1">&#39;STRASSE&#39;</span><span class="p">]):</span>
                <span class="n">dfRef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="n">dfRefStr</span><span class="p">]</span>

                <span class="n">extV</span> <span class="o">=</span> <span class="n">extV</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfRef</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">refName</span><span class="p">),</span> <span class="n">left_on</span><span class="o">=</span><span class="n">fkRefStr</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;pk&#39;</span> <span class="o">+</span>
                                  <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">refName</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">extV</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">refName</span><span class="p">])</span>
            
                
            <span class="c1"># Knotennamen</span>
            <span class="n">vKNOT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_BVZ_KNOT&#39;</span><span class="p">]</span>
            <span class="n">extV</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">extV</span><span class="p">,</span><span class="n">vKNOT</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_i&#39;</span><span class="p">)[[</span><span class="s1">&#39;tk_i&#39;</span><span class="p">,</span><span class="s1">&#39;NAME_i&#39;</span><span class="p">]],</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkKI&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;tk_i&#39;</span><span class="p">)</span>
            <span class="n">extV</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">extV</span><span class="p">,</span><span class="n">vKNOT</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_k&#39;</span><span class="p">)[[</span><span class="s1">&#39;tk_k&#39;</span><span class="p">,</span><span class="s1">&#39;NAME_k&#39;</span><span class="p">]],</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkKK&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;tk_k&#39;</span><span class="p">)</span>
            
            
            <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V3_ROHR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extV</span>

            <span class="c1"># V3_SWVT</span>
            <span class="c1"># #############################################################</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">: expanding V_BVZ_SWVT ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;V3_SWVT&#39;</span><span class="p">))</span>

            <span class="c1"># 1 Zeile pro RSLW der aktiv eine SWVT referenziert</span>
            <span class="c1"># NAME_SWVT_Nr gibt an, um die wie-vielte Referenz derselben SWVT es sich handelt</span>
            <span class="c1"># NAME_SWVT_NrMax gibt die max. Anzahl der Referenzierungen an; typischerwweise sollte NAME_SWVT_NrMax=1 sein für alle SWVT</span>
            <span class="c1"># (ZEIT, count)	... (W, max) sind Aggregate der referenzierten SWVT</span>

            <span class="c1">#vRSLW = self.dataFrames[&#39;V_BVZ_RSLW&#39;]</span>

            <span class="c1"># .sort_values(by=[&#39;pk&#39;,&#39;NAME&#39;,&#39;ZEIT&#39;])</span>
            <span class="n">vSWVT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_BVZ_SWVT&#39;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">vSWVT</span><span class="p">[</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">vSWVT</span><span class="p">[</span><span class="s1">&#39;ZEIT&#39;</span><span class="p">])</span>
                <span class="o">|</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">vSWVT</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">])</span>
            <span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}{:s}</span><span class="s2"> </span><span class="si">{:s}</span><span class="s2">: ZEIT und/oder W sind Null?!: ZEIT: </span><span class="si">{!s:s}</span><span class="s2"> W: </span><span class="si">{!s:s}</span><span class="s2">: Null-Wert(e) wird (werden) auf 0. gesetzt.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;vSWVT&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;ZEIT&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span>

            <span class="c1"># die erste Zeit wird oft mit NaN gelesen obwohl sie mit 0. eingegeben ist</span>
            <span class="n">vSWVT</span><span class="p">[</span><span class="s1">&#39;ZEIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vSWVT</span><span class="p">[</span><span class="s1">&#39;ZEIT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
            <span class="c1"># Werte mit NaN kann es iegentlich nicht geben ?! ...</span>
            <span class="n">vSWVT</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vSWVT</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>

            <span class="n">vSWVT</span> <span class="o">=</span> <span class="n">vSWVT</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;ZEIT&#39;</span><span class="p">])</span>

            <span class="n">V3_SWVT</span> <span class="o">=</span> <span class="n">vSWVT</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
                <span class="n">index</span><span class="o">=</span><span class="s1">&#39;ZEIT&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V3_SWVT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">V3_SWVT</span>

            <span class="c1"># V3_ROWT</span>
            <span class="c1"># #############################################################</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">: combining ROWT_tables like V_BVZ_LFKT, V_BVZ_PVAR, ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;V3_ROWT&#39;</span><span class="p">))</span>
            <span class="n">valColName</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;V_BVZ_LFKT&#39;</span><span class="p">:</span> <span class="s1">&#39;LF&#39;</span><span class="p">,</span> <span class="s1">&#39;V_BVZ_PHI1&#39;</span><span class="p">:</span> <span class="s1">&#39;PHI&#39;</span><span class="p">,</span> <span class="s1">&#39;V_BVZ_PUMD&#39;</span><span class="p">:</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;V_BVZ_PVAR&#39;</span><span class="p">:</span> <span class="s1">&#39;PH&#39;</span><span class="p">,</span> <span class="s1">&#39;V_BVZ_QVAR&#39;</span><span class="p">:</span> <span class="s1">&#39;QM&#39;</span><span class="p">,</span> <span class="s1">&#39;V_BVZ_TEVT&#39;</span><span class="p">:</span> <span class="s1">&#39;T&#39;</span>
                          <span class="p">}</span>
            <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewSets</span><span class="p">[</span><span class="s1">&#39;pairViews_ROWT&#39;</span><span class="p">]:</span>

                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="n">view</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="s1">&#39;ZEIT&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">():</span>
                    <span class="c1"># print(view)</span>

                    <span class="k">if</span> <span class="n">view</span> <span class="ow">in</span> <span class="n">valColName</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">vCN</span> <span class="o">=</span> <span class="n">valColName</span><span class="p">[</span><span class="n">view</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vCN</span> <span class="o">=</span> <span class="s1">&#39;W&#39;</span>

                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">vCN</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">})</span>

                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;ZEIT&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]]</span>

                    <span class="c1"># die erste Zeit wird oft mit NaN gelesen obwohl sie mit 0. eingegeben ist</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ZEIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ZEIT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>

                    <span class="c1"># print(df[[&#39;NAME&#39;,&#39;ZEIT&#39;,&#39;value&#39;]].head())</span>

                    <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

            <span class="n">dfAll</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V3_ROWT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfAll</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
                <span class="n">index</span><span class="o">=</span><span class="s1">&#39;ZEIT&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>

            <span class="c1"># V3_TFKT</span>
            <span class="c1"># #############################################################</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">: ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;V3_TFKT&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V3_TFKT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_BVZ_TFKT&#39;</span><span class="p">][[</span>
                <span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>

            <span class="c1"># V3_RSLW_SWVT</span>
            <span class="c1"># #############################################################</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">: combining RSLW and SWVT ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;V3_RSLW_SWVT&#39;</span><span class="p">))</span>

            <span class="n">vRSLW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_BVZ_RSLW&#39;</span><span class="p">]</span>

            <span class="n">vRSLW_SWVTAll</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">vRSLW</span><span class="p">,</span> <span class="n">vSWVT</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span>
                <span class="s1">&#39;_SWVT&#39;</span><span class="p">),</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkSWVT&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;pk_SWVT&#39;</span><span class="p">)</span>
            <span class="c1"># die aktiv eine Sollwerttabelle referenzieren ...</span>
            <span class="n">vRSLW_SWVTAll</span> <span class="o">=</span> <span class="n">vRSLW_SWVTAll</span><span class="p">[</span><span class="n">vRSLW_SWVTAll</span><span class="p">[</span><span class="s1">&#39;INDSLW&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">])]</span>
            <span class="c1"># .copy(deep=True) #  nur 1 Zeile pro Sollwerttabelle</span>
            <span class="n">vRSLW_SWVT</span> <span class="o">=</span> <span class="n">vRSLW_SWVTAll</span><span class="p">[</span><span class="n">vRSLW_SWVTAll</span><span class="p">[</span><span class="s1">&#39;lfdNrZEIT_SWVT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span>
                                                                            <span class="mi">1</span><span class="p">])]</span>

            <span class="n">vRSLW_SWVT</span> <span class="o">=</span> <span class="n">vRSLW_SWVT</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">vRSLW_SWVT</span><span class="p">[</span><span class="s1">&#39;NAME_SWVT_Nr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vRSLW_SWVT</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NAME_SWVT&#39;</span><span class="p">])[</span><span class="s1">&#39;NAME_SWVT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">vRSLW_SWVT</span><span class="p">[</span><span class="s1">&#39;NAME_SWVT_NrMax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vRSLW_SWVT</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NAME_SWVT&#39;</span><span class="p">])[</span><span class="s1">&#39;NAME_SWVT_Nr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>

            <span class="c1">#  Aggregate einer SWVT</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">vSWVT</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;ZEIT&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;last&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">],</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;last&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">]</span>
                 <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_flat_index</span><span class="p">()</span>

            <span class="c1"># diese Aggregate verfuegbar machen</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V3_RSLW_SWVT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">vRSLW_SWVT</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;NAME_SWVT&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;NAME&#39;</span><span class="p">)</span>

            <span class="c1"># V3_KNOT</span>
            <span class="c1"># #############################################################</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">: expanding V_BVZ_KNOT with NAME_LFKT, NAME_PVAR, NAME_PZON,NAME_QVAR,NAME_UTMP,NAME_FSTF,NAME_FQPS ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;V3_KNOT&#39;</span><span class="p">))</span>

            <span class="n">vKNOT</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_BVZ_KNOT&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_VKNO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span>
                <span class="s1">&#39;_VKNO&#39;</span><span class="p">),</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;tk&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;fkKNOT_VKNO&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

            <span class="n">extV</span> <span class="o">=</span> <span class="n">vKNOT</span>
            <span class="k">for</span> <span class="n">dfRefStr</span><span class="p">,</span> <span class="n">fkRefStr</span><span class="p">,</span> <span class="n">refName</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;LFKT&#39;</span><span class="p">,</span> <span class="s1">&#39;PVAR&#39;</span><span class="p">,</span> <span class="s1">&#39;PZON&#39;</span><span class="p">,</span> <span class="s1">&#39;QVAR&#39;</span><span class="p">,</span> <span class="s1">&#39;UTMP&#39;</span><span class="p">,</span> <span class="s1">&#39;FSTF&#39;</span><span class="p">,</span> <span class="s1">&#39;FQPS&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;fkLFKT&#39;</span><span class="p">,</span> <span class="s1">&#39;fkPVAR&#39;</span><span class="p">,</span> <span class="s1">&#39;fkPZON&#39;</span><span class="p">,</span> <span class="s1">&#39;fkQVAR&#39;</span><span class="p">,</span> <span class="s1">&#39;fkUTMP&#39;</span><span class="p">,</span> <span class="s1">&#39;fkFSTF&#39;</span><span class="p">,</span> <span class="s1">&#39;fkFQPS&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;LFKT&#39;</span><span class="p">,</span> <span class="s1">&#39;PVAR&#39;</span><span class="p">,</span> <span class="s1">&#39;PZON&#39;</span><span class="p">,</span> <span class="s1">&#39;QVAR&#39;</span><span class="p">,</span> <span class="s1">&#39;UTMP&#39;</span><span class="p">,</span> <span class="s1">&#39;FSTF&#39;</span><span class="p">,</span> <span class="s1">&#39;FQPS&#39;</span><span class="p">]):</span>
                <span class="n">dfRef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="n">dfRefStr</span><span class="p">]</span>

                <span class="n">extV</span> <span class="o">=</span> <span class="n">extV</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfRef</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">refName</span><span class="p">),</span> <span class="n">left_on</span><span class="o">=</span><span class="n">fkRefStr</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;pk&#39;</span> <span class="o">+</span>
                                  <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">refName</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">extV</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">refName</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V3_KNOT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extV</span>

            <span class="c1"># V3_FWVB</span>
            <span class="c1"># #############################################################</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">: expanding V_BVZ_FWVB with NAME_LFKT, NAME_ZEP1VL, NAME_ZEP1RL, NAME_TEVT, NAME_TRFT, tk_i, NAME_i, tk_k, NAME_k, ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;V3_FWVB&#39;</span><span class="p">))</span>
            <span class="n">extV_BVZ_FWVB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_BVZ_FWVB&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">dfRefStr</span><span class="p">,</span> <span class="n">fkRefStr</span><span class="p">,</span> <span class="n">refName</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;LFKT&#39;</span><span class="p">,</span> <span class="s1">&#39;ZEP1&#39;</span><span class="p">,</span> <span class="s1">&#39;ZEP1&#39;</span><span class="p">,</span> <span class="s1">&#39;TEVT&#39;</span><span class="p">,</span> <span class="s1">&#39;TRFT&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;fkLFKT&#39;</span><span class="p">,</span> <span class="s1">&#39;fkZEP1VL&#39;</span><span class="p">,</span> <span class="s1">&#39;fkZEP1RL&#39;</span><span class="p">,</span> <span class="s1">&#39;fkTEVT&#39;</span><span class="p">,</span> <span class="s1">&#39;fkTRFT&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;LFKT&#39;</span><span class="p">,</span> <span class="s1">&#39;ZEP1VL&#39;</span><span class="p">,</span> <span class="s1">&#39;ZEP1RL&#39;</span><span class="p">,</span> <span class="s1">&#39;TEVT&#39;</span><span class="p">,</span> <span class="s1">&#39;TRFT&#39;</span><span class="p">]):</span>
                <span class="n">dfRef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="n">dfRefStr</span><span class="p">]</span>
                <span class="n">extV_BVZ_FWVB</span> <span class="o">=</span> <span class="n">extV_BVZ_FWVB</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfRef</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span>
                    <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">refName</span><span class="p">),</span> <span class="n">left_on</span><span class="o">=</span><span class="n">fkRefStr</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;pk&#39;</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">refName</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">extV_BVZ_FWVB</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">refName</span><span class="p">])</span>
                
            <span class="c1"># Knotennamen</span>
            <span class="n">extV_BVZ_FWVB</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">extV_BVZ_FWVB</span><span class="p">,</span><span class="n">vKNOT</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_i&#39;</span><span class="p">)[[</span><span class="s1">&#39;tk_i&#39;</span><span class="p">,</span><span class="s1">&#39;NAME_i&#39;</span><span class="p">]],</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkKI&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;tk_i&#39;</span><span class="p">)</span>
            <span class="n">extV_BVZ_FWVB</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">extV_BVZ_FWVB</span><span class="p">,</span><span class="n">vKNOT</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_k&#39;</span><span class="p">)[[</span><span class="s1">&#39;tk_k&#39;</span><span class="p">,</span><span class="s1">&#39;NAME_k&#39;</span><span class="p">]],</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkKK&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;tk_k&#39;</span><span class="p">)</span>
                          
                
            <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V3_FWVB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extV_BVZ_FWVB</span>

            <span class="c1"># V3_:ROHR,KNOT,FWVB: filterTemplateObjects</span>
            <span class="c1"># #############################################################</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2"> filterTemplateObjects ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;V3_:ROHR,KNOT,FWVB:&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filterTemplateObjects</span><span class="p">()</span>

            <span class="c1"># #############################################################</span>
            <span class="c1"># VBEL (V3_VBEL) - &quot;alle&quot; Verbindungselementdaten des hydr. Prozessmodells; Knotendaten mit _i und _k</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">: ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;V3_VBEL&#39;</span><span class="p">))</span>

            <span class="n">vVBEL_UnionList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">vName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewSets</span><span class="p">[</span><span class="s1">&#39;pairViews_BZ&#39;</span><span class="p">]:</span>

                <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;^(V_BVZ_)(\w+)&#39;</span><span class="p">,</span> <span class="n">vName</span><span class="p">)</span>
                <span class="n">OBJTYPE</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

                <span class="n">dfVBEL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="n">vName</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;fkKI&#39;</span> <span class="ow">in</span> <span class="n">dfVBEL</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">():</span>
                    
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfVBEL</span><span class="p">,</span> <span class="n">vKNOT</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_i&#39;</span><span class="p">),</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkKI&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;tk_i&#39;</span>
                                  <span class="p">)</span>

                    <span class="c1">#logger.debug(&quot;{0:s}{1:s} in VBEL-View mit fkKI ({2:d},{3:d}) ...&quot;.format(</span>
                    <span class="c1">#    logStr, OBJTYPE, df.shape[0], df.shape[1]))</span>

                    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfVBEL</span><span class="p">,</span> <span class="n">vKNOT</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_i&#39;</span><span class="p">),</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkKI&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;pk_i&#39;</span>
                                      <span class="p">)</span>
                        <span class="c1">#if not df.empty:</span>
                        <span class="c1">#    logger.debug(&quot;{0:s}{1:s} in VBEL-View mit fkKI per pk! ({2:d},{3:d}) ...&quot;.format(</span>
                        <span class="c1">#        logStr, OBJTYPE, df.shape[0], df.shape[1]))</span>
                        <span class="c1">#else:</span>
                        <span class="c1">#    logger.debug(&quot;{0:s}{1:s} in VBEL-View mit fkKI LEER! ({2:d},{3:d}) ...&quot;.format(</span>
                        <span class="c1">#        logStr, OBJTYPE, df.shape[0], df.shape[1]))</span>

                    <span class="k">if</span> <span class="s1">&#39;fkKK&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">():</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">vKNOT</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_k&#39;</span><span class="p">),</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkKK&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;tk_k&#39;</span>
                                      <span class="p">)</span>

                        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfVBEL</span><span class="p">,</span> <span class="n">vKNOT</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_k&#39;</span><span class="p">),</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkKK&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;pk_k&#39;</span>
                                          <span class="p">)</span>
                            <span class="c1">#if not df.empty:</span>
                            <span class="c1">#    logger.debug(&quot;{0:s}{1:s} in VBEL-View mit fkKI und fkKK per pk! ({2:d},{3:d}) ...&quot;.format(</span>
                            <span class="c1">#        logStr, OBJTYPE, df.shape[0], df.shape[1]))</span>
                            <span class="c1">#else:</span>
                            <span class="c1">#    logger.debug(&quot;{0:s}{1:s} in VBEL-View mit fkKI und fkKK LEER! ({2:d},{3:d}) ...&quot;.format(</span>
                            <span class="c1">#        logStr, OBJTYPE, df.shape[0], df.shape[1]))</span>

                        <span class="c1"># m=re.search(&#39;^(V_BVZ_)(\w+)&#39;,vName)</span>
                        <span class="c1"># OBJTYPE=m.group(2)</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">OBJTYPE</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">OBJTYPE</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2"> final in V3_VBEL-View (</span><span class="si">{2:d}</span><span class="s2">,</span><span class="si">{3:d}</span><span class="s2">) ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">logStr</span><span class="p">,</span> <span class="n">OBJTYPE</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                            
                        <span class="n">vVBEL_UnionList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                        
                    <span class="k">elif</span> <span class="s1">&#39;KNOTK&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">():</span>
                        <span class="c1"># Nebenschlusselement</span>
                        <span class="k">pass</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">vKNOT</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_k&#39;</span><span class="p">),</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkKI&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;tk_k&#39;</span>
                                      <span class="p">)</span>
                        <span class="c1"># m=re.search(&#39;^(V_BVZ_)(\w+)&#39;,vName)</span>
                        <span class="c1"># OBJTYPE=m.group(2)</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">OBJTYPE</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">OBJTYPE</span><span class="p">)</span>

                        <span class="c1">#logger.debug(</span>
                        <span class="c1">#    &quot;{0:s}{1:s} (Nebenschluss) in VBEL-View ...&quot;.format(logStr, OBJTYPE))</span>
                        <span class="n">vVBEL_UnionList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

            <span class="n">vVBEL</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">vVBEL_UnionList</span><span class="p">)</span>
            <span class="n">vVBEL</span> <span class="o">=</span> <span class="n">Xm</span><span class="o">.</span><span class="n">Xm</span><span class="o">.</span><span class="n">constructNewMultiindexFromCols</span><span class="p">(</span>
                <span class="n">df</span><span class="o">=</span><span class="n">vVBEL</span><span class="p">,</span> <span class="n">mColNames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;OBJTYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;tk&#39;</span><span class="p">],</span> <span class="n">mIdxNames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;OBJTYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;OBJID&#39;</span><span class="p">])</span>
            <span class="n">vVBEL</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V3_VBEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vVBEL</span>

            <span class="c1"># #############################################################</span>
            <span class="c1"># V3_DPKT</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;V3_DPKT&#39;</span><span class="p">))</span>
            <span class="c1"># DPKT (V3_DPKT) - relevante Datenpunktdaten</span>
            <span class="k">if</span> <span class="s1">&#39;V_BVZ_DPKT&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">vDPKT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_BVZ_DPKT&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;V_DPKT&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">vDPKT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_DPKT&#39;</span><span class="p">]</span>


            <span class="n">vDPKT_DPGR1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">vDPKT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_DPGR_DPKT&#39;</span><span class="p">],</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;tk&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;fkDPKT&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_DPGR1&#39;</span><span class="p">))</span>

            <span class="n">vDPKT_DPGR</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">vDPKT_DPGR1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_BVZ_DPGR&#39;</span><span class="p">],</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkDPGR&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;tk&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_DPGR&#39;</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V3_DPKT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vDPKT_DPGR</span><span class="p">[[</span>
                    <span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="s1">&#39;tk&#39;</span><span class="p">,</span> <span class="s1">&#39;OBJTYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;fkOBJTYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;ATTRTYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;EPKZ&#39;</span><span class="p">,</span> <span class="s1">&#39;TITLE&#39;</span><span class="p">,</span> <span class="s1">&#39;UNIT&#39;</span><span class="p">,</span> <span class="s1">&#39;FLAGS&#39;</span><span class="p">,</span> <span class="s1">&#39;CLIENT_ID&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;CLIENT_FLAGS&#39;</span><span class="p">,</span> <span class="s1">&#39;OPCITEM_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;DESCRIPTION&#39;</span><span class="p">,</span>

                    <span class="s1">&#39;NAME1&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;NAME2&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;NAME3&#39;</span><span class="p">,</span>

                    <span class="s1">&#39;FACTOR&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ADDEND&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;DEVIATION&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;CHECK_ALL&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;CHECK_MSG&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;CHECK_ABS&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;LOWER_LIMIT&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;UPPER_LIMIT&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;LIMIT_TOLER&#39;</span>                 <span class="c1"># ---</span>
                    <span class="p">,</span> <span class="s1">&#39;tk_DPGR&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME&#39;</span>
                <span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">v3_dpkt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V3_DPKT&#39;</span><span class="p">]</span>
                <span class="n">v3_dpkt</span> <span class="o">=</span> <span class="n">v3_dpkt</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
                    <span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tk&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;tk&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="n">v3_dpkt</span> <span class="o">=</span> <span class="n">v3_dpkt</span><span class="p">[</span>
                    <span class="o">~</span><span class="n">v3_dpkt</span><span class="p">[</span><span class="s1">&#39;fkOBJTYPE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;-1&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V3_DPKT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v3_dpkt</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">logStr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V3_DPKT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vDPKT_DPGR</span><span class="p">[[</span>
                    <span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="s1">&#39;OBJTYPE&#39;</span>                    <span class="c1"># ,&#39;fkOBJTYPE&#39;</span>
                    <span class="p">,</span> <span class="s1">&#39;ATTRTYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;EPKZ&#39;</span><span class="p">,</span> <span class="s1">&#39;TITLE&#39;</span><span class="p">,</span> <span class="s1">&#39;UNIT&#39;</span><span class="p">,</span> <span class="s1">&#39;FLAGS&#39;</span>                    <span class="c1"># ,&#39;CLIENT_ID&#39;</span>
                    <span class="c1"># ,&#39;OPCITEM_ID&#39;</span>
                    <span class="p">,</span> <span class="s1">&#39;DESCRIPTION&#39;</span>                 <span class="c1"># ---</span>
                    <span class="p">,</span> <span class="s1">&#39;pk_DPGR&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME&#39;</span>
                <span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># #############################################################</span>
            <span class="c1"># RXXX (RKNOT,RRUES,RVBEL)</span>
            <span class="k">try</span><span class="p">:</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;V3_RKNOT&#39;</span><span class="p">))</span>

                <span class="c1"># RXXX-Nodes but RUES-Nodes</span>
                <span class="n">vRXXX_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RSLW&#39;</span><span class="p">,</span> <span class="s1">&#39;RMES&#39;</span><span class="p">,</span> <span class="s1">&#39;RHYS&#39;</span><span class="p">,</span> <span class="s1">&#39;RLVG&#39;</span><span class="p">,</span> <span class="s1">&#39;RLSR&#39;</span><span class="p">,</span> <span class="s1">&#39;RMMA&#39;</span><span class="p">,</span> <span class="s1">&#39;RADD&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;RMUL&#39;</span><span class="p">,</span> <span class="s1">&#39;RDIV&#39;</span><span class="p">,</span> <span class="s1">&#39;RTOT&#39;</span><span class="p">,</span> <span class="s1">&#39;RPT1&#39;</span><span class="p">,</span> <span class="s1">&#39;RINT&#39;</span><span class="p">,</span> <span class="s1">&#39;RPID&#39;</span><span class="p">,</span> <span class="s1">&#39;RFKT&#39;</span><span class="p">,</span> <span class="s1">&#39;RSTN&#39;</span><span class="p">]</span>
                <span class="n">vRXXX_UnionList</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">NODE</span> <span class="ow">in</span> <span class="n">vRXXX_nodes</span><span class="p">:</span>
                    <span class="n">vName</span> <span class="o">=</span> <span class="s1">&#39;V_BVZ_&#39;</span><span class="o">+</span><span class="n">NODE</span>
                    <span class="k">if</span> <span class="n">vName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">:</span>
                        <span class="n">vRXXX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="n">vName</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">vRXXX</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">vRXXX</span><span class="p">[</span><span class="s1">&#39;OBJTYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NODE</span>
                            <span class="n">vRXXX_UnionList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vRXXX</span><span class="p">)</span>
                <span class="n">vRXXX</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">vRXXX_UnionList</span><span class="p">)</span>
                <span class="n">vRXXX</span> <span class="o">=</span> <span class="n">vRXXX</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;KA&#39;</span><span class="p">:</span> <span class="s1">&#39;Kn&#39;</span><span class="p">})</span>

                <span class="c1"># all RXXX-Nodes</span>
                <span class="n">V3_RKNOT_UnionList</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># [[&#39;OBJTYPE&#39;,&#39;BESCHREIBUNG&#39;,&#39;Kn&#39;,&#39;NAME&#39;,&#39;pk&#39;]])</span>
                <span class="n">V3_RKNOT_UnionList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vRXXX</span><span class="p">)</span>
                <span class="n">V3_RKNOT</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">V3_RKNOT_UnionList</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V3_RKNOT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">V3_RKNOT</span>

                <span class="c1"># RUES</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;V3_RRUES&#39;</span><span class="p">))</span>
                <span class="c1"># wahre Quelle (wahre SRC) ermitteln</span>
                <span class="c1">#  Ues sind nur Aliase fuer Signale (fuer Knoten)</span>
                <span class="c1">#  fuer jede Alias-Definition den wahren Signalnamen (Knotennamen) ermitteln</span>

                <span class="c1"># alle Ues</span>
                <span class="n">vRUES</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_BVZ_RUES&#39;</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">vRUES</span><span class="p">[</span><span class="o">~</span><span class="n">vRUES</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;-1&#39;</span><span class="p">])]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                                
                    <span class="c1"># alle Kanten (alle Signalverbindungen)</span>
                    <span class="n">vCRGL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_CRGL&#39;</span><span class="p">]</span>
                    <span class="c1"># Ue-Definitionen per Kante (per Signal):</span>
                    <span class="n">vRUESDefs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                        <span class="n">vRUES</span><span class="p">,</span> <span class="n">vCRGL</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;fkKk&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_Edge&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">vRUESDefs</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">vRUES: Referenz zu pk leer?! ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">))</span>
                        <span class="n">vRUESDefs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                            <span class="n">vRUES</span><span class="p">,</span> <span class="n">vCRGL</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;tk&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;fkKk&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_Edge&#39;</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">rows</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">vRUESDefs</span><span class="o">.</span><span class="n">shape</span>
                        <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">vRUES</span><span class="p">,</span> <span class="n">vCRGL</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;tk&#39;</span><span class="p">,</span>
                                       <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;fkKk&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_Edge&#39;</span><span class="p">))</span>
                        <span class="n">rows2</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">shape</span>
                        <span class="k">if</span> <span class="n">rows2</span> <span class="o">&gt;=</span> <span class="n">rows</span><span class="p">:</span>
                            <span class="c1">#logger.debug(</span>
                            <span class="c1">#    &quot;{0:s}vRUES:: Referenz zu pk nicht leer aber tk findet mindestens genausoviel Treffer ...&quot;.format(logStr))</span>
                            <span class="n">vRUESDefs</span> <span class="o">=</span> <span class="n">df2</span>
                            
                            
                    <span class="c1"># Kontrollausgaben</span>
                    <span class="c1">#logger.debug(&quot;{logStr:s}vRUESDefs: {vRUESDefs:s}&quot;.format(logStr=logStr,vRUESDefs=vRUESDefs.to_string()))      </span>
                    
                    <span class="c1">#logger.debug(&quot;{logStr:s}V3_RKNOT: {V3_RKNOT:s}&quot;.format(logStr=logStr,V3_RKNOT=V3_RKNOT.to_string()))      </span>
                       
                    <span class="k">def</span> <span class="nf">get_UE_SRC</span><span class="p">(</span><span class="n">UeName</span>  <span class="c1"># Name der Ue deren SRC gesucht wird</span>
                                   <span class="p">,</span> <span class="n">dfUes</span>  <span class="c1"># alle Ues (Defs und Refs)</span>
                                   <span class="p">,</span> <span class="n">dfUesDefs</span>  <span class="c1"># alle Signalverbindungen die Ues definieren</span>
                                   <span class="p">):</span>
<span class="w">                        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        gibt per df diejenige Zeile von dfUesDefs zurueck die schlussendlich UeName definiert</span>
<span class="sd">                        fkKi ist dann die wahre Quelle von UeName</span>
<span class="sd">                        fkKi verweist dabei _nicht auf eine andere Ue, d.h. verkettete Referenzen werden bis zur wahren Quelle aufgeloest</span>
<span class="sd">                        &quot;&quot;&quot;</span>
    
                        <span class="n">df</span> <span class="o">=</span> <span class="n">dfUesDefs</span><span class="p">[</span><span class="n">dfUesDefs</span><span class="p">[</span><span class="s1">&#39;IDUE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">UeName</span><span class="p">]</span>
    
                        <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fkKi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">dfUes</span><span class="p">[</span><span class="s1">&#39;tk&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">():</span>
                            
                            <span class="c1"># die SRC der Ue ist eine Ue</span>
                            <span class="c1">#logger.debug(&quot;Die SRC der Ue {:s} ist eine Ue - die Ue-Def:\n{:s}&quot;.format(</span>
                            <span class="c1">#    UeName, str(df[[&#39;IDUE&#39;, &#39;pk&#39;, &#39;rkRUES&#39;, &#39;fkKi&#39;, &#39;fkKk&#39;]].iloc[0])))</span>
    
                            <span class="c1"># die Referenz</span>
                            <span class="n">df</span> <span class="o">=</span> <span class="n">dfUes</span><span class="p">[</span><span class="n">dfUes</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fkKi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                            <span class="n">df</span> <span class="o">=</span> <span class="n">dfUes</span><span class="p">[</span><span class="n">dfUes</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span> <span class="o">==</span>
                                       <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rkRUES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>  <span class="c1"># die SRC</span>
    
                            <span class="c1"># print(&quot;{:s}&quot;.format((str(df[[&#39;IDUE&#39;,&#39;pk&#39;</span>
                            <span class="c1">#                                                                      ,&#39;rkRUES&#39;</span>
                            <span class="c1">#                            #                                          ,&#39;fkKi&#39;,&#39;fkKk&#39;</span>
                            <span class="c1">#                            ]].iloc[0]))))</span>
    
                            <span class="c1"># Rekursion bis zur wahren Quelle</span>
                            <span class="n">df</span> <span class="o">=</span> <span class="n">get_UE_SRC</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;IDUE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dfUes</span><span class="p">,</span> <span class="n">dfUesDefs</span>
                                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">pass</span>
                            <span class="c1"># Log wieder AUS</span>
                            <span class="c1">#logger.debug(&quot;Die SRC der Ue {:s} gefunden -die Ue-Def:\n{:s}&quot;.format(</span>
                            <span class="c1">#    UeName, str(df[[&#39;IDUE&#39;, &#39;pk&#39;, &#39;rkRUES&#39;, &#39;fkKi&#39;, &#39;fkKk&#39;]].iloc[0])))</span>
    
                        <span class="k">return</span> <span class="n">df</span>
    
                    <span class="c1"># fuer jede Ue-Definition die SRC bestimmen</span>
    
                    <span class="n">dcts</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">vRUESDefs</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    
                        <span class="n">dfX</span> <span class="o">=</span> <span class="n">get_UE_SRC</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;IDUE&#39;</span><span class="p">]</span>  <span class="c1"># Name der Ue deren SRC gesucht wird</span>
                                         <span class="p">,</span> <span class="n">vRUES</span>  <span class="c1"># Ues</span>
                                         <span class="p">,</span> <span class="n">vRUESDefs</span>  <span class="c1"># Ue-Definitionen per Kante</span>
                                         <span class="p">)</span>
                        
                        <span class="c1">#logger.debug(&quot;{logStr:s}dfX: {dfX:s}&quot;.format(logStr=logStr,dfX=dfX.to_string()))      </span>
                                            
                        <span class="c1"># df[&#39;fkKi&#39;] ist die SRC</span>
                        <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>                                        
                        
                        <span class="n">df</span> <span class="o">=</span> <span class="n">V3_RKNOT</span><span class="p">[</span><span class="n">V3_RKNOT</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dfX</span><span class="p">[</span><span class="s1">&#39;fkKi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                            
                            <span class="c1">#logger.debug(</span>
                            <span class="c1">#    &quot;{0:s}V3_RKNOT: Referenz zu pk leer?! ...&quot;.format(logStr))</span>
    
                            <span class="n">df</span> <span class="o">=</span> <span class="n">V3_RKNOT</span><span class="p">[</span><span class="n">V3_RKNOT</span><span class="p">[</span><span class="s1">&#39;tk&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dfX</span><span class="p">[</span><span class="s1">&#39;fkKi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">df2</span> <span class="o">=</span> <span class="n">V3_RKNOT</span><span class="p">[</span><span class="n">V3_RKNOT</span><span class="p">[</span><span class="s1">&#39;tk&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dfX</span><span class="p">[</span><span class="s1">&#39;fkKi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    
                            <span class="n">rows</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span>
                            <span class="n">rows2</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">shape</span>
    
                            <span class="k">if</span> <span class="n">rows2</span> <span class="o">&gt;=</span> <span class="n">rows</span><span class="p">:</span>
                                <span class="c1">#logger.debug(</span>
                                <span class="c1">#    &quot;{0:s}V3_RKNOT: Referenz zu pk nicht leer aber tk findet mindestens genausoviel Treffer ...&quot;.format(logStr))</span>
                                <span class="n">df</span> <span class="o">=</span> <span class="n">df2</span>
                        
                        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>                        
                             <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}{:12s}</span><span class="s2"> </span><span class="si">{:s}</span><span class="s2">: UE-Symbol ohne Referenz?!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;IDUE&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;NAME_CONT&#39;</span><span class="p">]))</span>        
    
                             <span class="n">dct</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pk_DEF&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">],</span> <span class="s1">&#39;tk_DEF&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;tk&#39;</span><span class="p">],</span> <span class="s1">&#39;IDUE_DEF&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;IDUE&#39;</span><span class="p">]</span>                           <span class="c1">#</span>
                                    <span class="p">,</span> <span class="s1">&#39;OBJTYPE_SRC&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;OBJID_SRC&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Kn_SRC&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;NAME_CONT_SRC&#39;</span><span class="p">:</span> <span class="kc">None</span>
                                    <span class="p">}</span>
                             <span class="c1">### dcts.append(dct) #?!</span>
                                                         
                        <span class="k">else</span><span class="p">:</span>
    
                             <span class="n">dct</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pk_DEF&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">],</span> <span class="s1">&#39;tk_DEF&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;tk&#39;</span><span class="p">],</span> <span class="s1">&#39;IDUE_DEF&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;IDUE&#39;</span><span class="p">]</span>                           <span class="c1">#</span>
                                   <span class="p">,</span> <span class="s1">&#39;OBJTYPE_SRC&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;OBJTYPE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;OBJID_SRC&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Kn_SRC&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Kn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;NAME_CONT_SRC&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;NAME_CONT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                   <span class="p">}</span>
                             <span class="n">dcts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>
    
                        <span class="c1"># break</span>
                    <span class="n">vRUESDefsSRCs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dcts</span><span class="p">)</span>
                    
                    <span class="c1"># UE-Symbole ohne Referenzen sind hier nicht enthalten</span>
                    <span class="c1">#logger.debug(&quot;{logStr:s}vRUESDefsSRCs: {vRUESDefsSRCs:s}&quot;.format(logStr=logStr,vRUESDefsSRCs=vRUESDefsSRCs.sort_values(by=[&#39;IDUE_DEF&#39;]).to_string())) </span>
                    
                    <span class="c1"># Ausgabe, wo das Ue nicht so heisst wie die Quelle ...</span>
                    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">vRUESDefsSRCs</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;IDUE_DEF&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                        
                        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;IDUE_DEF&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Kn_SRC&#39;</span><span class="p">]:</span>
                            <span class="k">pass</span>
                            <span class="c1">#logger.debug(&quot;{logStr:s}IDUE_DEF: {IDUE_DEF!s:s} != Kn_SRC: {Kn_SRC!s:s} - ggf. ungewollt? ...&quot;.format(logStr=logStr</span>
                            <span class="c1">#        ,IDUE_DEF=row[&#39;IDUE_DEF&#39;]</span>
                            <span class="c1">#        ,Kn_SRC=row[&#39;Kn_SRC&#39;]</span>
                            <span class="c1">#            )) </span>
                        
                    <span class="c1"># fuer alle Defs die wahre Quelle angeben</span>
                    <span class="c1">#vRUES: self.dataFrames[&#39;V_BVZ_RUES&#39;]</span>
                    <span class="n">V3_RUES</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">vRUES</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">vRUESDefsSRCs</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;IDUE&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;IDUE_DEF&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                    
                    <span class="c1">#logger.debug(&quot;{logStr:s}V3_RUES Schritt 1: {V3_RUES:s}&quot;.format(logStr=logStr,V3_RUES=V3_RUES[[&#39;NAME_CONT&#39;,&#39;IDUE&#39;,&#39;IDUE_DEF&#39;,&#39;Kn_SRC&#39;,&#39;rkRUES&#39;]].sort_values(by=[&#39;IDUE_DEF&#39;]).to_string())) </span>
    
                    <span class="c1"># fuer alle Refs ebenfalls die wahre Quelle angeben</span>
                    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">V3_RUES</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                        <span class="c1">#logger.debug(&quot;{logStr:s}{IDUE_DEF!s:s}&quot;.format(logStr=logStr,IDUE_DEF=row[&#39;IDUE_DEF&#39;])) </span>
                        
                        
                        <span class="c1">#logger.debug(&quot;{logStr:s}IDUE_DEF: {IDUE_DEF!s:s}, Kn_SRC: {Kn_SRC!s:s}&quot;.format(logStr=logStr</span>
                        <span class="c1">#        ,IDUE_DEF=row[&#39;IDUE_DEF&#39;]</span>
                        <span class="c1">#        ,Kn_SRC=row[&#39;Kn_SRC&#39;]</span>
                        <span class="c1">#            ))                     </span>
                                            
                        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;IDUE_DEF&#39;</span><span class="p">]):</span>
                                                                                             
                            <span class="n">rkRUES</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;rkRUES&#39;</span><span class="p">]</span>
                            
                            <span class="n">dfx</span><span class="o">=</span><span class="n">vRUESDefsSRCs</span><span class="p">[</span><span class="n">vRUESDefsSRCs</span><span class="p">[</span><span class="s1">&#39;tk_DEF&#39;</span><span class="p">]</span><span class="o">==</span> <span class="n">rkRUES</span><span class="p">]</span>
                            
                            <span class="p">(</span><span class="n">Treffer</span><span class="p">,</span><span class="n">dummy</span><span class="p">)</span><span class="o">=</span><span class="n">dfx</span><span class="o">.</span><span class="n">shape</span>
    
                            <span class="c1">#logger.debug(&quot;{logStr:s}IDUE_DEF ist NULL, rkRUES: {rkRUES:s}, Treffer: {Treffer:d}&quot;.format(logStr=logStr                                </span>
                            <span class="c1">#        ,rkRUES=row[&#39;rkRUES&#39;]</span>
                            <span class="c1">#        ,Treffer=Treffer</span>
                            <span class="c1">#            ))  </span>
                                                    
                            <span class="k">if</span> <span class="n">Treffer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    
                                <span class="c1">#logger.debug(&quot;{logStr:s}IDUE_DEF ist NULL, rkRUES: {rkRUES:s}, KEIN Treffer?!&quot;.format(logStr=logStr                                </span>
                                <span class="c1">#        ,rkRUES=row[&#39;rkRUES&#39;]                                    </span>
                                <span class="c1">#            ))   </span>
                                <span class="k">continue</span>
                                                                        
                            <span class="k">if</span> <span class="n">Treffer</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="k">pass</span>
                                <span class="c1">#logger.debug(&quot;{logStr:s}IDUE_DEF ist NULL, rkRUES: {rkRUES:s}, MEHR als 1 Treffer: {Treffer:d}?!&quot;.format(logStr=logStr                                </span>
                                <span class="c1">#        ,rkRUES=row[&#39;rkRUES&#39;]</span>
                                <span class="c1">#        ,Treffer=Treffer</span>
                                <span class="c1">#            ))                              </span>
                                                    
                            <span class="n">s</span> <span class="o">=</span> <span class="n">dfx</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>                            
        
                            <span class="n">V3_RUES</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;pk_DEF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;pk_DEF&#39;</span><span class="p">]</span>
                            <span class="n">V3_RUES</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;IDUE_DEF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;IDUE_DEF&#39;</span><span class="p">]</span>
                            <span class="n">V3_RUES</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;OBJTYPE_SRC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;OBJTYPE_SRC&#39;</span><span class="p">]</span>
                            <span class="n">V3_RUES</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;Kn_SRC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;Kn_SRC&#39;</span><span class="p">]</span>
                            <span class="n">V3_RUES</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;NAME_CONT_SRC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;NAME_CONT_SRC&#39;</span><span class="p">]</span>
    
                            
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V3_RRUES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">V3_RUES</span>
                    <span class="c1">#logger.debug(&quot;{logStr:s}V3_RRUES final: {V3_RUES:s}&quot;.format(logStr=logStr</span>
                    <span class="c1">#                                                            ,V3_RUES=V3_RUES[[&#39;NAME_CONT&#39;,&#39;NAME_CONT_SRC&#39;,&#39;OBJTYPE_SRC&#39;,&#39;IDUE&#39;,&#39;IDUE_DEF&#39;,&#39;Kn_SRC&#39;,&#39;rkRUES&#39;,&#39;pk_DEF&#39;]].sort_values(by=[&#39;IDUE_DEF&#39;]).to_string()))                 </span>
    
                    <span class="c1"># RKNOT voruebergehend erweitern um RUES um nachfolgend alle Kanten ausreferenzieren zu koennen</span>
                    <span class="c1">#logger.debug(&quot;{0:s}expanding V3_KNOT with V3_RRUES temporarily to construct V3_RVBEL ...&quot;.format(logStr))</span>
    
                    <span class="n">V3_RKNOT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V3_RKNOT&#39;</span><span class="p">]</span>
                    <span class="n">vRUES</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_BVZ_RUES&#39;</span><span class="p">]</span>
                    <span class="n">vRUES</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">vRUES</span><span class="p">,</span> <span class="n">vRUES</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;rkRUES&#39;</span><span class="p">,</span>
                                     <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;tk&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_rkRUES&#39;</span><span class="p">))</span>
                    <span class="n">vRUES</span><span class="p">[</span><span class="s1">&#39;Kn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vRUES</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">IDUE</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">IOTYP</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span> <span class="k">else</span> <span class="n">row</span><span class="o">.</span><span class="n">IDUE_rkRUES</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">vRUES</span><span class="p">[</span><span class="s1">&#39;OBJTYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;RUES&#39;</span>
                    <span class="n">vRUES</span><span class="p">[</span><span class="s1">&#39;BESCHREIBUNG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">V3_RKNOT</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">V3_RKNOT</span><span class="p">,</span> <span class="n">vRUES</span><span class="p">[[</span>
                                         <span class="s1">&#39;OBJTYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;Kn&#39;</span><span class="p">,</span> <span class="s1">&#39;BESCHREIBUNG&#39;</span><span class="p">,</span> <span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="s1">&#39;tk&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME_CONT&#39;</span><span class="p">,</span> <span class="s1">&#39;IDUE&#39;</span><span class="p">,</span> <span class="s1">&#39;IOTYP&#39;</span><span class="p">]]])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
                <span class="c1"># alle RXXX-Kanten</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;V3_RVBEL&#39;</span><span class="p">))</span>
                
                <span class="n">howMode</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span>
                <span class="n">V_CRGL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_CRGL&#39;</span><span class="p">]</span>
                
                <span class="n">V3_RVBEL</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">V_CRGL</span><span class="p">,</span> <span class="n">V3_RKNOT</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span>
                    <span class="s1">&#39;_i&#39;</span><span class="p">),</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkKi&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;tk_i&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="n">howMode</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">V_CRGL</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;OBJTYPE_i&#39;</span><span class="p">,</span><span class="s1">&#39;pk_i&#39;</span><span class="p">,</span><span class="s1">&#39;tk_i&#39;</span><span class="p">,</span><span class="s1">&#39;Kn_i&#39;</span><span class="p">,</span><span class="s1">&#39;NAME_CONT_i&#39;</span><span class="p">])</span>
                <span class="n">V3_RVBEL</span><span class="p">[</span><span class="s1">&#39;KnExt_i&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">V3_RVBEL</span><span class="p">[</span><span class="s1">&#39;Kn_i&#39;</span><span class="p">]</span> <span class="o">+</span> \
                    <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">V3_RVBEL</span><span class="p">[</span><span class="s1">&#39;OBJTYPE_i&#39;</span><span class="p">]</span>
                    
                <span class="n">V3_RVBEL</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">V3_RVBEL</span><span class="p">,</span> <span class="n">V3_RKNOT</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span>
                    <span class="s1">&#39;_k&#39;</span><span class="p">),</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkKk&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;tk_k&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="n">howMode</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">V3_RVBEL</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;OBJTYPE_k&#39;</span><span class="p">,</span><span class="s1">&#39;pk_k&#39;</span><span class="p">,</span><span class="s1">&#39;tk_k&#39;</span><span class="p">,</span><span class="s1">&#39;Kn_k&#39;</span><span class="p">,</span><span class="s1">&#39;NAME_CONT_k&#39;</span><span class="p">])</span>
                <span class="n">V3_RVBEL</span><span class="p">[</span><span class="s1">&#39;KnExt_k&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">V3_RVBEL</span><span class="p">[</span><span class="s1">&#39;Kn_k&#39;</span><span class="p">]</span> <span class="o">+</span> \
                    <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">V3_RVBEL</span><span class="p">[</span><span class="s1">&#39;OBJTYPE_k&#39;</span><span class="p">]</span>

                <span class="n">V3_RVBEL</span> <span class="o">=</span> <span class="n">Xm</span><span class="o">.</span><span class="n">Xm</span><span class="o">.</span><span class="n">constructNewMultiindexFromCols</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">V3_RVBEL</span><span class="p">,</span> <span class="n">mColNames</span><span class="o">=</span><span class="p">[</span>
                                                                <span class="s1">&#39;OBJTYPE_i&#39;</span><span class="p">,</span> <span class="s1">&#39;OBJTYPE_k&#39;</span><span class="p">,</span> <span class="s1">&#39;pk&#39;</span><span class="p">],</span> <span class="n">mIdxNames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;OBJTYPE_i&#39;</span><span class="p">,</span> <span class="s1">&#39;OBJTYPE_k&#39;</span><span class="p">,</span> <span class="s1">&#39;OBJID&#39;</span><span class="p">])</span>

                <span class="n">V3_RVBEL</span> <span class="o">=</span> <span class="n">V3_RVBEL</span><span class="p">[</span><span class="o">~</span><span class="n">V3_RVBEL</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span>
                    <span class="s1">&#39;OBJTYPE_k&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;RUES&#39;</span><span class="p">])]</span>

                <span class="n">V3_RVBEL</span> <span class="o">=</span> <span class="n">V3_RVBEL</span><span class="p">[</span><span class="o">~</span>
                                    <span class="p">(</span>
                                        <span class="p">(</span><span class="n">V3_RVBEL</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span>
                                            <span class="s1">&#39;OBJTYPE_i&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;RUES&#39;</span><span class="p">]))</span>
                                        <span class="o">&amp;</span>
                                        <span class="p">(</span><span class="n">V3_RVBEL</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span>
                                            <span class="s1">&#39;OBJTYPE_k&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;RUES&#39;</span><span class="p">]))</span>
                                    <span class="p">)</span>
                                    <span class="p">]</span>


                <span class="k">if</span> <span class="ow">not</span> <span class="n">vRUES</span><span class="p">[</span><span class="n">vRUES</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                
                    <span class="c1"># RUES-Verbindungen zur Quelle hin aufloesen ...                </span>
                    <span class="c1">#logger.debug(&quot;{0:s}{1:s} RUES-Verbindungen zur Quelle hin aufloesen ...&quot;.format(logStr, &#39;V3_RVBEL&#39;))</span>
    
                    <span class="n">V3_RVBEL</span> <span class="o">=</span> <span class="n">V3_RVBEL</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                    <span class="n">V3_RRUES</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V3_RRUES&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">V3_RVBEL</span><span class="p">[</span><span class="n">V3_RVBEL</span><span class="p">[</span><span class="s1">&#39;OBJTYPE_i&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;RUES&#39;</span><span class="p">])]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                        
                        <span class="n">dfx</span><span class="o">=</span><span class="n">V3_RRUES</span><span class="p">[</span><span class="n">V3_RRUES</span><span class="p">[</span><span class="s1">&#39;tk&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fkKi&#39;</span><span class="p">]]</span>
                        <span class="p">(</span><span class="n">Treffer</span><span class="p">,</span><span class="n">dummy</span><span class="p">)</span><span class="o">=</span><span class="n">dfx</span><span class="o">.</span><span class="n">shape</span>
                        
                        <span class="k">if</span> <span class="n">Treffer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                   
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{logStr:s}</span><span class="s2">OBJTYPE_i: </span><span class="si">{OBJTYPE_i:s}</span><span class="s2"> Kn_i: </span><span class="si">{Kn_i:s}</span><span class="s2">  KEIN Treffer?!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="o">=</span><span class="n">logStr</span>                                
                                    <span class="p">,</span><span class="n">OBJTYPE_i</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;OBJTYPE_i&#39;</span><span class="p">]</span>      
                                    <span class="p">,</span><span class="n">Kn_i</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Kn_i&#39;</span><span class="p">]</span>      
                                        <span class="p">))</span>   
                            <span class="k">continue</span>
                                                                    
                        <span class="k">if</span> <span class="n">Treffer</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{logStr:s}</span><span class="s2">OBJTYPE_i: </span><span class="si">{OBJTYPE_i:s}</span><span class="s2"> Kn_i: </span><span class="si">{Kn_i:s}</span><span class="s2">  MEHR als 1 Treffer: </span><span class="si">{Treffer:d}</span><span class="s2">?!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="o">=</span><span class="n">logStr</span>                                
                                    <span class="p">,</span><span class="n">OBJTYPE_i</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;OBJTYPE_i&#39;</span><span class="p">]</span>      
                                    <span class="p">,</span><span class="n">Kn_i</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Kn_i&#39;</span><span class="p">]</span>      
                                    <span class="p">,</span><span class="n">Treffer</span><span class="o">=</span><span class="n">Treffer</span>
                                        <span class="p">))</span>                           
                                                                                          
                        <span class="n">s</span> <span class="o">=</span> <span class="n">dfx</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        
                        <span class="c1">#logger.debug(&quot;{logStr:s}OBJTYPE_i: {OBJTYPE_i:s} Kn_i: {Kn_i:s} Treffer: {Treffer!s:s}?!&quot;.format(logStr=logStr                                </span>
                        <span class="c1">#        ,OBJTYPE_i=row[&#39;OBJTYPE_i&#39;]      </span>
                        <span class="c1">#        ,Kn_i=row[&#39;Kn_i&#39;]      </span>
                        <span class="c1">#        ,Treffer=s</span>
                        <span class="c1">#            ))         </span>
    
                        <span class="n">V3_RVBEL</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;OBJTYPE_i&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;OBJTYPE_SRC&#39;</span><span class="p">]</span>
                        <span class="c1"># V3_RVBEL.loc[index,&#39;OBJID_i&#39;]=s[&#39;OBJID_SRC&#39;]</span>
                        <span class="n">V3_RVBEL</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;Kn_i&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;Kn_SRC&#39;</span><span class="p">]</span>
                        <span class="n">V3_RVBEL</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;KnExt_i&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;Kn_SRC&#39;</span><span class="p">])</span> <span class="o">+</span> \
                            <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;OBJTYPE_SRC&#39;</span><span class="p">])</span>
                        <span class="n">V3_RVBEL</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;NAME_CONT_i&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;NAME_CONT_SRC&#39;</span><span class="p">]</span>

                
                    <span class="n">V3_RVBEL</span><span class="o">=</span><span class="n">V3_RVBEL</span><span class="p">[</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">V3_RVBEL</span><span class="p">[</span><span class="s1">&#39;tk&#39;</span><span class="p">])]</span>
                    <span class="n">V3_RVBEL</span> <span class="o">=</span> <span class="n">Xm</span><span class="o">.</span><span class="n">Xm</span><span class="o">.</span><span class="n">constructNewMultiindexFromCols</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">V3_RVBEL</span><span class="p">,</span> <span class="n">mColNames</span><span class="o">=</span><span class="p">[</span>
                                                                    <span class="s1">&#39;OBJTYPE_i&#39;</span><span class="p">,</span> <span class="s1">&#39;OBJTYPE_k&#39;</span><span class="p">,</span> <span class="s1">&#39;OBJID&#39;</span><span class="p">],</span> <span class="n">mIdxNames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;OBJTYPE_i&#39;</span><span class="p">,</span> <span class="s1">&#39;OBJTYPE_k&#39;</span><span class="p">,</span> <span class="s1">&#39;OBJID&#39;</span><span class="p">])</span>
                
                
                <span class="n">V3_RVBEL</span><span class="o">=</span><span class="n">V3_RVBEL</span><span class="p">[</span><span class="o">~</span><span class="n">V3_RVBEL</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;-1&#39;</span><span class="p">])]</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V3_RVBEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">V3_RVBEL</span>
                                
                <span class="c1"># Modell-Pk des in QGIS anzuzeigenden Modells    </span>
                <span class="c1"># ============================================</span>
                <span class="n">sk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;SYSTEMKONFIG&#39;</span><span class="p">]</span>  
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">QGISmodelXk</span><span class="o">=</span><span class="n">sk</span><span class="p">[</span><span class="n">sk</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mf">3.</span><span class="p">])][</span><span class="s1">&#39;WERT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{logStr:s}</span><span class="s2"> SYSTEMKONFIG ID 3 not defined. Value(ID=3) is supposed to define the Model which is used in QGIS. Now QGISmodelXk is undefined ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="o">=</span><span class="n">logStr</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">QGISmodelXk</span><span class="o">=</span><span class="kc">None</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">logStr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">logStr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">DxError</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;_Done.#########&#39;</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_dfLAYR</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        dfLAYR is a dx object Attribute.</span>
<span class="sd">                </span>
<span class="sd">        .. note::             </span>
<span class="sd">            Groups (also called Layers) are used in SIR 3S as a feature for data access, data filtering and grouping. </span>
<span class="sd">            </span>
<span class="sd">            The returned dfLAYR (one row per LAYR and OBJ) has the following columns:</span>
<span class="sd">                </span>
<span class="sd">                 LAYR:</span>
<span class="sd">                     - pk</span>
<span class="sd">                     - tk</span>
<span class="sd">                     - LFDNR (numeric)</span>
<span class="sd">                     - NAME</span>
<span class="sd">                </span>
<span class="sd">                 LAYR-Info:</span>
<span class="sd">                     - AnzDerObjekteInGruppe</span>
<span class="sd">                     - AnzDerObjekteDesTypsInGruppe</span>
<span class="sd">                </span>
<span class="sd">                 OBJ:</span>
<span class="sd">                     - TYPE</span>
<span class="sd">                     - ID</span>
<span class="sd">                </span>
<span class="sd">                 OBJ-Info:</span>
<span class="sd">                     - NrDesObjektesDesTypsInGruppe</span>
<span class="sd">                     - NrDesObjektesInGruppe</span>
<span class="sd">                     - GruppenDesObjektsAnz</span>
<span class="sd">                     - GruppenDesObjektsNamen       </span>
<span class="sd">                      </span>
<span class="sd">        &quot;&quot;&quot;</span>   
                
        <span class="n">logStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">.</span><span class="si">{1:s}</span><span class="s2">: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">logStr</span><span class="si">}</span><span class="s2">Start.&quot;</span><span class="p">)</span> 
        
        <span class="k">try</span><span class="p">:</span> 
            <span class="n">dfLAYR</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="n">dfLAYR</span><span class="o">=</span><span class="n">dxDecodeObjsData</span><span class="o">.</span><span class="n">Layr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>                                   
            <span class="k">return</span> <span class="n">dfLAYR</span>     
        <span class="k">except</span> <span class="n">DxError</span><span class="p">:</span>
            <span class="k">raise</span>            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logStrFinal</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span> 
            <span class="k">raise</span> <span class="n">DxError</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>                       
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">logStr</span><span class="si">}</span><span class="s2">_Done.&quot;</span><span class="p">)</span> 

    <span class="k">def</span> <span class="nf">MxSync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        adds mx2Idx to V3_KNOT, V3_ROHR, V3_FWVB, V3_VBEL, etc.</span>
<span class="sd">        adds mx2NofPts, dL to V3_ROHR          </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">.</span><span class="si">{1:s}</span><span class="s2">: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;Start.&#39;</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">dfName</span><span class="p">,</span> <span class="n">resType</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;V3_KNOT&#39;</span><span class="p">,</span> <span class="s1">&#39;V3_ROHR&#39;</span><span class="p">,</span> <span class="s1">&#39;V3_FWVB&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;KNOT&#39;</span><span class="p">,</span> <span class="s1">&#39;ROHR&#39;</span><span class="p">,</span> <span class="s1">&#39;FWVB&#39;</span><span class="p">]):</span>

                <span class="k">if</span> <span class="n">mx</span><span class="o">.</span><span class="n">mx2Df</span><span class="p">[</span><span class="n">mx</span><span class="o">.</span><span class="n">mx2Df</span><span class="p">[</span><span class="s1">&#39;ObjType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">resType</span><span class="p">)]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">resType: </span><span class="si">{:s}</span><span class="s2"> hat keine mx2-Eintraege.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="n">resType</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>
                    <span class="c1">#logger.debug(</span>
                    <span class="c1">#    &quot;{:s}resType: {:s} ...&quot;.format(logStr, resType))</span>

                <span class="c1"># mx2Idx ergaenzen</span>

                <span class="c1"># Liste der IDs in Mx2</span>
                <span class="n">xksMx</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">mx2Df</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">mx</span><span class="o">.</span><span class="n">mx2Df</span><span class="p">[</span><span class="s1">&#39;ObjType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">resType</span><span class="p">))</span>
                    <span class="o">&amp;</span>  <span class="c1"># nur wg. ROHRe erf.</span>
                    <span class="o">~</span><span class="p">(</span><span class="n">mx</span><span class="o">.</span><span class="n">mx2Df</span><span class="p">[</span><span class="s1">&#39;AttrType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;N_OF_POINTS&#39;</span><span class="p">))</span>
                <span class="p">][</span><span class="s1">&#39;Data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># xk: pk oder tk</span>
                <span class="n">xkTypeMx</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">mx2Df</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">mx</span><span class="o">.</span><span class="n">mx2Df</span><span class="p">[</span><span class="s1">&#39;ObjType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">resType</span><span class="p">))</span>
                    <span class="o">&amp;</span>  <span class="c1"># nur wg. ROHRe erf.</span>
                    <span class="o">~</span><span class="p">(</span><span class="n">mx</span><span class="o">.</span><span class="n">mx2Df</span><span class="p">[</span><span class="s1">&#39;AttrType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;N_OF_POINTS&#39;</span><span class="p">))</span>
                <span class="p">][</span><span class="s1">&#39;AttrType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="c1"># lesen</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="n">dfName</span><span class="p">]</span>

                <span class="c1"># Liste der xks</span>
                <span class="n">xksXm</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">xkTypeMx</span><span class="p">]</span>

                <span class="c1"># zugeh. Liste der mx2Idx in df</span>
                <span class="n">mxXkIdx</span> <span class="o">=</span> <span class="p">[</span><span class="n">xksMx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span> <span class="k">for</span> <span class="n">xk</span> <span class="ow">in</span> <span class="n">xksXm</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">resType</span> <span class="o">==</span> <span class="s1">&#39;ROHR&#39;</span><span class="p">:</span>

                    <span class="c1"># Liste der N_OF_POINTS in Mx2</span>
                    <span class="n">nopMx</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">mx2Df</span><span class="p">[</span>
                        <span class="p">(</span><span class="n">mx</span><span class="o">.</span><span class="n">mx2Df</span><span class="p">[</span><span class="s1">&#39;ObjType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">resType</span><span class="p">))</span>
                        <span class="o">&amp;</span>
                        <span class="p">(</span><span class="n">mx</span><span class="o">.</span><span class="n">mx2Df</span><span class="p">[</span><span class="s1">&#39;AttrType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;N_OF_POINTS&#39;</span><span class="p">))</span>
                    <span class="p">][</span><span class="s1">&#39;Data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1"># zugeh. Liste der NOfPts in df</span>
                    <span class="n">nopXk</span> <span class="o">=</span> <span class="p">[</span><span class="n">nopMx</span><span class="p">[</span><span class="n">mx2Idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">mx2Idx</span> <span class="ow">in</span> <span class="n">mxXkIdx</span><span class="p">]</span>

                    <span class="c1"># Spalte mx2NofPts anlegen </span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mx2NofPts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">nopXk</span><span class="p">)</span>
                    <span class="c1"># Spalte dL anlegen </span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;mx2NofPts&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    
                    
                <span class="c1"># Spalte mx2Idx als letzte Spalte anlegen</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mx2Idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">mxXkIdx</span><span class="p">)</span>
        
            <span class="c1"># V3_VBEL</span>
            <span class="c1"># ####################</span>
    
            <span class="k">try</span><span class="p">:</span> 
    
                <span class="c1"># new col mx2Idx in dfVBEL</span>
                <span class="n">dfVBEL</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V3_VBEL&#39;</span><span class="p">]</span>
                <span class="n">dfVBEL</span><span class="o">=</span><span class="n">dfVBEL</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">mx2Idx</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">dfVBEL</span><span class="p">[</span><span class="s1">&#39;mx2Idx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span><span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
                <span class="c1"># all edges</span>
                <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="p">[</span><span class="n">edge</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> 
                             <span class="c1">#[&#39;ROHR&#39;,&#39;VENT&#39;,&#39;FWVB&#39;,&#39;FWES&#39;,&#39;PUMP&#39;,&#39;KLAP&#39;,&#39;REGV&#39;,&#39;PREG&#39;,&#39;MREG&#39;,&#39;DPRG&#39;,&#39;PGRP&#39;]</span>
                             <span class="n">dfVBEL</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
                             <span class="p">]:</span>
                     <span class="k">try</span><span class="p">:</span>    
                         
                         
                         <span class="k">if</span> <span class="n">mx</span><span class="o">.</span><span class="n">mx2Df</span><span class="p">[</span><span class="n">mx</span><span class="o">.</span><span class="n">mx2Df</span><span class="p">[</span><span class="s1">&#39;ObjType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">edge</span><span class="p">)]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                             <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                 <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">resType: </span><span class="si">{:s}</span><span class="s2"> hat keine mx2-Eintraege.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="n">edge</span><span class="p">))</span>
                             <span class="k">continue</span>
                         <span class="k">else</span><span class="p">:</span>
                             <span class="k">pass</span>
                             <span class="c1">#logger.debug(</span>
                             <span class="c1">#    &quot;{:s}resType: {:s} ...&quot;.format(logStr, resType))</span>
                         
                         
                         
                         
                         
                         <span class="c1"># die Schluessel</span>
                         <span class="n">xksEDGEMx</span><span class="o">=</span><span class="n">mx</span><span class="o">.</span><span class="n">mx2Df</span><span class="p">[</span>
                                    <span class="p">(</span><span class="n">mx</span><span class="o">.</span><span class="n">mx2Df</span><span class="p">[</span><span class="s1">&#39;ObjType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">edge</span><span class="p">))</span>
                             <span class="p">][</span><span class="s1">&#39;Data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
                         <span class="c1"># der Schluesselbezug &#39;tk&#39; oder &#39;xk&#39;</span>
                         <span class="n">xkTypeMx</span><span class="o">=</span><span class="n">mx</span><span class="o">.</span><span class="n">mx2Df</span><span class="p">[</span>
                                    <span class="p">(</span><span class="n">mx</span><span class="o">.</span><span class="n">mx2Df</span><span class="p">[</span><span class="s1">&#39;ObjType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">edge</span><span class="p">))</span>
                             <span class="p">][</span><span class="s1">&#39;AttrType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    
                         <span class="c1"># Sequenz der Schluessel in V3_VBEL   </span>
                         <span class="k">if</span> <span class="n">xkTypeMx</span> <span class="o">==</span> <span class="s1">&#39;tk&#39;</span><span class="p">:</span>
                            <span class="n">xksEDGEXm</span><span class="o">=</span><span class="n">dfVBEL</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">edge</span><span class="p">,),:]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span> <span class="c1">#dfVBEL.loc[(edge,),xkTypeMx]</span>
                         <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># pk</span>
                            <span class="n">xksEDGEXm</span><span class="o">=</span><span class="n">dfVBEL</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">edge</span><span class="p">,),</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="c1">#dfVBEL.loc[(edge,),:].index</span>
    
                         <span class="c1">#logger.debug(&quot;{0:s}{1:s}: xkTypeMx: {2:s}&quot;.format(logStr,edge,xkTypeMx))   </span>
                         <span class="c1">#logger.debug(&quot;{0:s}{1:s}: xksEDGEXm: {2:s}&quot;.format(logStr,edge,str(xksEDGEXm.tolist())))   </span>
                         <span class="c1">#logger.debug(&quot;{0:s}{1:s}: xksEDGEMx: {2:s}&quot;.format(logStr,edge,str(xksEDGEMx)))      </span>
                                          
                         <span class="n">mxXkEDGEIdx</span><span class="o">=</span><span class="p">[</span><span class="n">xksEDGEMx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span> <span class="k">for</span> <span class="n">xk</span> <span class="ow">in</span> <span class="n">xksEDGEXm</span><span class="p">]</span>
                         
                         <span class="n">dfVBEL</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">edge</span><span class="p">,),</span><span class="s1">&#39;mx2Idx&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">mxXkEDGEIdx</span>
    
                     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logStrEdge</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">: mx2Idx for </span><span class="si">{:s}</span><span class="s2"> failed. mx2Idx = -1.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span><span class="n">edge</span><span class="p">)</span>            
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">logStrEdge</span><span class="p">)</span> 
                                                                                                                   
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logStrFinal</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>            
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span> 
                              
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1">#logger.debug(&quot;{0:s}{1:s}&quot;.format(logStr,&#39;_Done.&#39;))    </span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V3_VBEL&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dfVBEL</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">logStr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">DxError</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;_Done.&#39;</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">MxAdd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mx</span><span class="p">,</span> <span class="n">addNodeData</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">addNodeDataSir3sVecIDReExps</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;^KNOT~\*~\*~\*~PH$&#39;</span><span class="p">,</span><span class="s1">&#39;^KNOT~\*~\*~\*~H$&#39;</span><span class="p">,</span><span class="s1">&#39;^KNOT~\*~\*~\*~T$&#39;</span><span class="p">,</span><span class="s1">&#39;^KNOT~\*~\*~\*~RHO$&#39;</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        adds Vec-Results using mx&#39; getVecAggsResultsForObjectType to V3_KNOT, V3_ROHR, V3_FWVB, V3_VBEL, ggf. weitere</span>

<span class="sd">        returns dct V3s; keys: V3_KNOT, V3_ROHR, V3_FWVB, V3_VBEL, ggf. weitere</span>
<span class="sd">        source: V3_KNOT, V3_ROHR, V3_FWVB, V3_VBEL, ggf. weitere      </span>

<span class="sd">        columns: </span>
<span class="sd">            einzelne Strings (Sachdaten) und Tupel (Ergebnisdaten)</span>
<span class="sd">            bei addNodeData sind bei den VBEL die ergaenzten Knotenergebnisspalten auch Strings mit _i/_k am Ende            </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">.</span><span class="si">{1:s}</span><span class="s2">: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;Start.&#39;</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            
            <span class="n">V3</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">dfKnotRes</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            
            <span class="k">for</span> <span class="n">dfName</span><span class="p">,</span> <span class="n">resType</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;V3_KNOT&#39;</span><span class="p">,</span> <span class="s1">&#39;V3_ROHR&#39;</span><span class="p">,</span> <span class="s1">&#39;V3_FWVB&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;^KNOT&#39;</span><span class="p">,</span> <span class="s1">&#39;^ROHR~&#39;</span><span class="p">,</span> <span class="s1">&#39;^FWVB&#39;</span><span class="p">]):</span>
                <span class="c1"># Ergebnisse lesen</span>
                
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">logStr</span><span class="si">}</span><span class="s2">dfName: </span><span class="si">{</span><span class="n">dfName</span><span class="si">}</span><span class="s2">: read Results:&quot;</span><span class="p">)</span>
                
                <span class="k">try</span><span class="p">:</span>
                
                    <span class="n">dfRes</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">getVecAggsResultsForObjectType</span><span class="p">(</span><span class="n">resType</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dfRes</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
    
                        <span class="c1">#logger.debug(&quot;{0:s}dfRes: {1:s}&quot;.format(logStr,dfRes.to_string()))</span>
        
                        <span class="k">if</span> <span class="n">dfName</span> <span class="o">==</span> <span class="s1">&#39;V3_KNOT&#39;</span> <span class="ow">and</span> <span class="n">addNodeData</span><span class="p">:</span>
        
                            <span class="c1"># df mit Knotenergebnissen merken</span>
                            <span class="n">dfKnotRes</span> <span class="o">=</span> <span class="n">dfRes</span>
                            <span class="c1"># gewünschte Ergebnisspalten von Knoten</span>
                            <span class="n">Sir3sIDs</span> <span class="o">=</span> <span class="n">dfKnotRes</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            
                            <span class="n">Sir3sIDsMatching</span><span class="o">=</span><span class="p">[]</span>
                            <span class="k">for</span> <span class="n">addNodeDataSir3sVecIDReExp</span> <span class="ow">in</span> <span class="n">addNodeDataSir3sVecIDReExps</span><span class="p">:</span>
                                <span class="n">Sir3sIDsMatching</span> <span class="o">=</span> <span class="n">Sir3sIDsMatching</span> <span class="o">+</span> <span class="p">[</span><span class="n">Sir3sID</span> <span class="k">for</span> <span class="n">Sir3sID</span> <span class="ow">in</span> <span class="n">Sir3sIDs</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                                    <span class="n">addNodeDataSir3sVecIDReExp</span><span class="p">,</span> <span class="n">Sir3sID</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">]</span>
                                                
                            <span class="c1"># die zur Ergänzung gewünschten Ergebnisspalten von Knoten</span>
                            <span class="n">dfKnotRes</span> <span class="o">=</span> <span class="n">dfKnotRes</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span>
                                <span class="kc">None</span><span class="p">),</span> <span class="n">Sir3sIDsMatching</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">))]</span>
                                         
                            <span class="n">dfKnotRes</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dfKnotRes</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_flat_index</span><span class="p">()</span>
                    
                        <span class="n">dfRes</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dfRes</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_flat_index</span><span class="p">()</span>
        
                        <span class="c1">#Sachspalten lesen</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="n">dfName</span><span class="p">]</span>
        
                        <span class="c1"># Ergebnisspalten ergänzen                </span>
                        <span class="n">V3</span><span class="p">[</span><span class="n">dfName</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                                <span class="n">dfRes</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;tk&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>  
                    
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">V3</span><span class="p">[</span><span class="n">dfName</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="n">dfName</span><span class="p">]</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                     <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                         <span class="n">logStr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                     <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">addNodeData</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dfKnotRes</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">dfName</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;V3_ROHR&#39;</span><span class="p">,</span> <span class="s1">&#39;V3_FWVB&#39;</span><span class="p">]:</span>
                    
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">logStr</span><span class="si">}</span><span class="s2">dfName: </span><span class="si">{</span><span class="n">dfName</span><span class="si">}</span><span class="s2">: addNodeData:&quot;</span><span class="p">)</span>
                    
                    <span class="k">try</span><span class="p">:</span>                    
                        <span class="n">df</span> <span class="o">=</span> <span class="n">V3</span><span class="p">[</span><span class="n">dfName</span><span class="p">]</span>
                        
                        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dfKnotRes</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span>
                            <span class="s1">&#39;_i&#39;</span><span class="p">),</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkKI&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>   
                        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dfKnotRes</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span>
                            <span class="s1">&#39;_k&#39;</span><span class="p">),</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkKK&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>   
                             
                        <span class="n">V3</span><span class="p">[</span><span class="n">dfName</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
                        
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                         <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                             <span class="n">logStr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                         <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>
            
                                            
            <span class="c1"># V3_VBEL</span>
            <span class="c1"># ####################</span>
    
            <span class="n">dfVBEL</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V3_VBEL&#39;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dfVBEL before edge loop:</span><span class="se">\n</span><span class="si">{</span><span class="n">df</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1">#logger.debug(&quot;{0:s}dfVBEL: {1:s}&quot;.format(logStr,dfVBEL.head().to_string()))</span>
            
            <span class="c1"># QM</span>
            <span class="n">dfOBJTYPEs</span><span class="o">=</span><span class="n">mx</span><span class="o">.</span><span class="n">getVecAggsResultsForAttributeType</span><span class="p">()</span>
            
            <span class="c1"># all edges</span>
            <span class="n">dfs</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="p">[</span><span class="n">edge</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">dfVBEL</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()]:</span>
                  <span class="k">try</span><span class="p">:</span>    
                                                          
                    <span class="n">df</span><span class="o">=</span><span class="n">dfOBJTYPEs</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df after df=dfOBJTYPEs[edge]:</span><span class="se">\n</span><span class="si">{</span><span class="n">df</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1">#logger.debug(f&quot;{logStr}{edge}: {type(df)}&quot;)</span>
                    
                    <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_flat_index</span><span class="p">()</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df after df.columns = [str(col) for col in df.columns]:</span><span class="se">\n</span><span class="si">{</span><span class="n">df</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1">#df.columns = [str(col) for col in df.columns]</span>
                    <span class="c1">#df = df.rename(columns=lambda x: x + &#39;_df&#39;)</span>
                    
                    <span class="n">newCols</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df after df.columns:</span><span class="se">\n</span><span class="si">{</span><span class="n">df</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfVBEL</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">edge</span><span class="p">,),:],</span><span class="n">df</span><span class="p">,</span><span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_VBEL&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">newCols</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df after merge:</span><span class="se">\n</span><span class="si">{</span><span class="n">df</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;OBJID&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;OBJTYPE&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">edge</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df after new OBJID OBJTYPE cols:</span><span class="se">\n</span><span class="si">{</span><span class="n">df</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="c1">#logger.debug(f&quot;{logStr}{edge}: {type(df)}&quot;)</span>
                    <span class="c1">#logger.debug(f&quot;{logStr}{edge}: {df.head()}&quot;)</span>
                    
                    <span class="c1">#logger.debug(f&quot;df before constructNewMultiindexFromCols data types:\n{df.dtypes}&quot;)</span>
                    <span class="c1">#logger.debug(f&quot;df before constructNewMultiindexFromCols dimensions: {df.shape}&quot;)</span>
                    <span class="c1">#logger.debug(f&quot;df before constructNewMultiindexFromCols:\n{df}&quot;)</span>
                    <span class="n">df</span><span class="o">=</span><span class="n">dxAndMxHelperFcts</span><span class="o">.</span><span class="n">constructNewMultiindexFromCols</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                                        
                    <span class="c1">#df=pd.merge(dfVBEL.loc[(edge,),:],df,left_index=True,right_index=True)</span>
                    <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                     
                    <span class="c1">#for newCol in newCols: </span>
                    <span class="c1">#    pass</span>
                    <span class="c1">#dfVBEL.loc[(edge,),newCols]=df[newCols].values</span>

                  <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>                               
                    <span class="n">logStrEdge</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">: Edge-Type </span><span class="si">{:s}</span><span class="s2">: adding Vec-Results failed.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span><span class="n">edge</span><span class="p">)</span>            
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">logStrEdge</span><span class="p">)</span>             
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dfVBEL</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfVBEL</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">),</span><span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">dfVBEL nach concat: </span><span class="si">{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span><span class="n">dfVBEL</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dfKnotRes before addNodeData:</span><span class="se">\n</span><span class="si">{</span><span class="n">dfKnotRes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="c1"># contains QM Data</span>
            
            <span class="k">if</span> <span class="n">addNodeData</span><span class="p">:</span>
                
                <span class="n">dfVBEL</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfVBEL</span><span class="p">,</span> <span class="n">dfKnotRes</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_i&#39;</span><span class="p">),</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkKI&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                <span class="n">dfVBEL</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfVBEL</span><span class="p">,</span> <span class="n">dfKnotRes</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_k&#39;</span><span class="p">),</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkKK&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                                                                                                                      
            <span class="n">V3</span><span class="p">[</span><span class="s1">&#39;V3_VBEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfVBEL</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dfVBEL before return:</span><span class="se">\n</span><span class="si">{</span><span class="n">dfVBEL</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                    
            <span class="k">return</span> <span class="n">V3</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">logStr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">DxError</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;_Done.&#39;</span><span class="p">))</span>
            <span class="c1">#return V3</span>

    <span class="k">def</span> <span class="nf">ShpAdd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapeFile</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s1">&#39;EPSG:25832&#39;</span><span class="p">,</span> <span class="n">onlyObjectsInContainerLst</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;M-1-0-1&#39;</span><span class="p">],</span> <span class="n">addNodeData</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">NodeDataKey</span><span class="o">=</span><span class="s1">&#39;pk&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns dct with (hopefully) plottable GeoDataFrames; keys: V3_KNOT, V3_ROHR, V3_FWVB, ggf. weitere</span>
<span class="sd">        source: V3_KNOT, V3_ROHR, V3_FWVB, ggf. weitere</span>

<span class="sd">        adds Geometry from shapeFile (3S Shapefile-Export) to V3_KNOT, V3_ROHR, V3_FWVB, ggf. weitere</span>

<span class="sd">        geometry is set to shapeFile&#39;s column geometry</span>
<span class="sd">        crs is set to crs</span>

<span class="sd">        auch wenn SIR 3S ab N zukuenftig nativ eine Geometriespalte haelt, kann es sinnvoll sein </span>
<span class="sd">        fuer bestimmte Darstellungszwecke Geometrien (zu generieren) und hier zuzuordnen </span>

<span class="sd">        V3_FWVB:</span>
<span class="sd">            Geometry: LineString is converted to Point </span>
<span class="sd">        V3_ROHR and V3_FWVB:</span>
<span class="sd">            if addNodeData: all V3_KNOT Data is added as columns named with postfix _i and _k</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">.</span><span class="si">{1:s}</span><span class="s2">: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;Start.&#39;</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">shpGdf</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">shapeFile</span><span class="p">)</span>
            <span class="n">shpGdf</span><span class="o">.</span><span class="n">set_crs</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">shpGdf</span> <span class="o">=</span> <span class="n">shpGdf</span><span class="p">[[</span><span class="s1">&#39;3SPK&#39;</span><span class="p">,</span> <span class="s1">&#39;TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
            <span class="n">shpGdf</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;TYPE&#39;</span><span class="p">:</span> <span class="s1">&#39;TYPE_shp&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">V3</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dfName</span><span class="p">,</span> <span class="n">shapeType</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;V3_KNOT&#39;</span><span class="p">,</span> <span class="s1">&#39;V3_ROHR&#39;</span><span class="p">,</span> <span class="s1">&#39;V3_FWVB&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;KNOT&#39;</span><span class="p">,</span> <span class="s1">&#39;ROHR&#39;</span><span class="p">,</span> <span class="s1">&#39;FWVB&#39;</span><span class="p">]):</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="n">dfName</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;geometry&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">():</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">)</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">shpGdf</span><span class="p">[</span><span class="n">shpGdf</span><span class="o">.</span><span class="n">TYPE_shp</span> <span class="o">==</span> <span class="n">shapeType</span><span class="p">],</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;3SPK&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                        <span class="n">items</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span>
                    <span class="n">gdf</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">)</span>
                    <span class="n">gdf</span><span class="o">.</span><span class="n">set_crs</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span>
                        <span class="c1"># nur Objekte fuer die das shapeFile eine Geometrieinformation geliefert hat</span>
                        <span class="o">~</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]))</span>
                        <span class="o">&amp;</span>
                        <span class="c1"># keine Objekte in z.B. Stationen</span>
                        <span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;NAME_CONT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">onlyObjectsInContainerLst</span><span class="p">))</span>
                    <span class="p">]</span>
                    <span class="n">V3</span><span class="p">[</span><span class="n">dfName</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">logStr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>
                <span class="c1"># empty DataFrame if problem occured</span>
                <span class="n">V3</span><span class="p">[</span><span class="n">dfName</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

            <span class="c1"># Nacharbeiten FWVB</span>
            <span class="k">if</span> <span class="s1">&#39;V3_FWVB&#39;</span> <span class="ow">in</span> <span class="n">V3</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">gdf</span> <span class="o">=</span> <span class="n">V3</span><span class="p">[</span><span class="s1">&#39;V3_FWVB&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">linestring</span><span class="o">.</span><span class="n">LineString</span><span class="p">):</span>
                            <span class="n">gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">centroid</span>
                <span class="n">V3</span><span class="p">[</span><span class="s1">&#39;V3_FWVB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span>

            <span class="c1"># Nacharbeiten addNodeData</span>
            <span class="k">if</span> <span class="n">addNodeData</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dfName</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;V3_ROHR&#39;</span><span class="p">,</span> <span class="s1">&#39;V3_FWVB&#39;</span><span class="p">]:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">V3</span><span class="p">[</span><span class="n">dfName</span><span class="p">]</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V3_KNOT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span>
                        <span class="s1">&#39;_i&#39;</span><span class="p">),</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkKI&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="n">NodeDataKey</span><span class="o">+</span><span class="s1">&#39;_i&#39;</span><span class="p">)</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V3_KNOT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span>
                        <span class="s1">&#39;_k&#39;</span><span class="p">),</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkKK&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="n">NodeDataKey</span><span class="o">+</span><span class="s1">&#39;_k&#39;</span><span class="p">)</span>
                    <span class="n">V3</span><span class="p">[</span><span class="n">dfName</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">logStr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">DxError</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;_Done.&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">V3</span>

    <span class="k">def</span> <span class="nf">_filterTemplateObjects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;        </span>
<span class="sd">        filters TemplateObjects </span>
<span class="sd">        in V3_KNOT, V3_ROHR, V3_FWVB</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">.</span><span class="si">{1:s}</span><span class="s2">: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;Start.&#39;</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dfName</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;V3_KNOT&#39;</span><span class="p">,</span> <span class="s1">&#39;V3_ROHR&#39;</span><span class="p">,</span> <span class="s1">&#39;V3_FWVB&#39;</span><span class="p">]:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="n">dfName</span><span class="p">]</span>
                <span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="n">dummy</span><span class="p">)</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span>
                <span class="k">if</span> <span class="s1">&#39;KENNUNG&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">():</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;KENNUNG&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="o">|</span>
                            <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;KENNUNG&#39;</span><span class="p">]))</span>
                            <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;BESCHREIBUNG&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;^Templ&#39;</span><span class="p">,</span><span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
                
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">logStr</span><span class="si">}{</span><span class="n">dfName</span><span class="si">}</span><span class="s2">: Zeilen vorher: </span><span class="si">{</span><span class="n">rows</span><span class="si">}</span><span class="s2"> Zeilen jetzt: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="n">dfName</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">logStr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">DxError</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">pass</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;_Done.&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_vROHRVecs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vROHR</span><span class="p">,</span> <span class="n">mx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds MX-ROHR-VEC-Results in dfVecAggs as cols to df.</span>

<span class="sd">        Args:</span>
<span class="sd">            vROHR: df (i.a. dataFrames[&#39;V3_ROHR&#39;])</span>
<span class="sd">            cols expected in vROHR (call MxSync to add this cols to dataFrames[&#39;V3_ROHR&#39;]):</span>
<span class="sd">                mx2Idx</span>
<span class="sd">                mx2NofPts</span>

<span class="sd">        Returns:</span>
<span class="sd">            df with </span>
<span class="sd">                vROHR&#39;s cols </span>
<span class="sd">                IptIdx (S(tart), 0,1,2,3,... ,E(nde))</span>
<span class="sd">                x: fortl. Rohrachskoordinate errechnet aus L und mx2NofPts</span>
<span class="sd">                cols with MX-ROHR-VEC-Results i.e. (STAT, ROHR~*~*~*~MVEC, 2022-09-28 13:24:00, 2022-09-28 13:24:00)                          </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">.</span><span class="si">{1:s}</span><span class="s2">: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;Start.&#39;</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

            <span class="c1"># alle MX-ROHR-VEC-Results in dfVecAggs</span>
            <span class="n">dfT</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">dfVecAggs</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">mx</span><span class="o">.</span><span class="n">getRohrVektorkanaeleIpkt</span><span class="p">(),</span> <span class="nb">slice</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)),</span> <span class="p">:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="n">dfT</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dfT</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_flat_index</span><span class="p">()</span>
            <span class="c1"># cols= (STAT, ROHR~*~*~*~MVEC, 2022-09-28 13:24:00, 2022-09-28 13:24:00) ...</span>
            <span class="c1"># idx= 0,1,2,3,...</span>

            <span class="c1"># dfT mit mx2Idx annotieren, damit merge vROHR moeglich</span>
            <span class="c1"># dfT mit IptIdx annotieren, damit IPKT-Sequenz leichter lesbar</span>
            <span class="n">rVecMx2Idx</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">IptIdx</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Mx2-Records sind in Mx2-Reihenfolge und muessen auch so annotiert werden ...</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">vROHR</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;mx2Idx&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
                <span class="n">oneVecIdx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">mx2NofPts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">oneVecIdx</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">mx2Idx</span><span class="p">)</span>
                <span class="n">rVecMx2Idx</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">oneVecIdx</span><span class="p">)</span>

                <span class="n">oneLfdNrIdx</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">mx2NofPts</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">oneLfdNrIdx</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">mx2NofPts</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>
                <span class="n">oneLfdNrIdx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;E&#39;</span><span class="p">)</span>
                <span class="n">IptIdx</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">oneLfdNrIdx</span><span class="p">)</span>

            <span class="n">dfTCols</span> <span class="o">=</span> <span class="n">dfT</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="n">dfT</span><span class="p">[</span><span class="s1">&#39;mx2Idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rVecMx2Idx</span>
            <span class="n">dfT</span><span class="p">[</span><span class="s1">&#39;IptIdx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">IptIdx</span>

            <span class="c1"># merge</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">vROHR</span><span class="p">,</span> <span class="n">dfT</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span>
                          <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;mx2Idx&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;mx2Idx&#39;</span><span class="p">)</span>

            <span class="c1"># x</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">L</span><span class="o">/</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">mx2NofPts</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;mx2Idx&#39;</span><span class="p">)[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">x</span><span class="o">-</span><span class="n">row</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Reorg der Spalten</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">vROHR</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="o">+</span>
                           <span class="p">[</span><span class="s1">&#39;IptIdx&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">dfTCols</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">logStr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;_Done.&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_vROHRVrtx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vROHR</span><span class="p">,</span> <span class="n">mx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds MX-ROHR-VRTX-Results in dfVecAggs as cols to df.</span>

<span class="sd">        Args:</span>
<span class="sd">            vROHR: df (i.a. dataFrames[&#39;V3_ROHR&#39;])</span>


<span class="sd">        Returns:</span>
<span class="sd">            df with </span>
<span class="sd">                vROHR&#39;s cols </span>
<span class="sd">                VRTX-Cols:</span>
<span class="sd">                    pk_Vrtx</span>
<span class="sd">                    fk_Vrtx</span>
<span class="sd">                    XKOR</span>
<span class="sd">                    YKOR</span>
<span class="sd">                    ZKOR</span>
<span class="sd">                    LFDNR</span>
<span class="sd">                    mx2IdxVrtx        </span>
<span class="sd">                        the df is sorted by mx2IdxVrtx (should be equal to sort by ROHR, VRTX-LFDNR)</span>
<span class="sd">                s: fortl. Rohrachskoordinate errechnet aus VRTX</span>
<span class="sd">                cols with MX-ROHR-VRTX-Results i.e. (STAT, ROHR_VRTX~*~*~*~M, 2022-09-28 13:24:00, 2022-09-28 13:24:00)                          </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">.</span><span class="si">{1:s}</span><span class="s2">: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;Start.&#39;</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

            <span class="c1"># alle MX-ROHR-VRTX-Results in dfVecAggs</span>
            <span class="n">dfT</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">dfVecAggs</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">mx</span><span class="o">.</span><span class="n">getRohrVektorkanaeleVrtx</span><span class="p">(),</span> <span class="nb">slice</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)),</span> <span class="p">:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="n">dfT</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dfT</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_flat_index</span><span class="p">()</span>
            <span class="c1"># cols= (STAT, ROHR~*~*~*~MVEC, 2022-09-28 13:24:00, 2022-09-28 13:24:00) ...</span>
            <span class="c1"># idx= 0,1,2,3,...</span>

            <span class="c1"># Liste der VRTX-PKs in MX2</span>
            <span class="n">xksMx</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">mx2Df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">mx</span><span class="o">.</span><span class="n">mx2Df</span><span class="p">[</span><span class="s1">&#39;ObjType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;ROHR_VRTX&#39;</span><span class="p">))</span>
            <span class="p">][</span><span class="s1">&#39;Data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">vROHR_VRTX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;V_ROHR_VRTX&#39;</span><span class="p">]</span>
            <span class="c1"># diese Liste sollte leer sein:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xksMx</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vROHR_VRTX</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Es gibt Verweise in MX2 die auf keinen VRTX-Wegpunkt zeigen?!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">))</span>

            <span class="c1"># -1 aussortieren</span>
            <span class="c1"># keine Sachdaten VRTX-Wegpunkte ohne Nennung in MX-VRTX</span>
            <span class="n">vROHR_VRTX_eff</span> <span class="o">=</span> <span class="n">vROHR_VRTX</span><span class="p">[</span><span class="n">vROHR_VRTX</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">xksMx</span><span class="p">)]</span>

            <span class="c1"># nur die Sach-ROHRe die Sach-Wegpunkte haben</span>
            <span class="n">vROHR_eff</span> <span class="o">=</span> <span class="n">vROHR</span><span class="p">[</span><span class="n">vROHR</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">vROHR_VRTX_eff</span><span class="p">[</span><span class="s1">&#39;fk&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span>

            <span class="c1"># Wegpunkte</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">vROHR_eff</span><span class="p">,</span> <span class="n">vROHR_VRTX_eff</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">,</span>
                                                                  <span class="s1">&#39;fk&#39;</span><span class="p">,</span>
                                                                  <span class="s1">&#39;XKOR&#39;</span><span class="p">,</span>
                                                                  <span class="s1">&#39;YKOR&#39;</span><span class="p">,</span>
                                                                  <span class="s1">&#39;ZKOR&#39;</span><span class="p">,</span>
                                                                  <span class="s1">&#39;LFDNR&#39;</span><span class="p">,</span>
                                                                  <span class="p">]),</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;fk&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_Vrtx&#39;</span><span class="p">))</span>

            <span class="c1"># Vorbereitung fuer Merge mit MX</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mx2IdxVrtx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">xksMx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span> <span class="k">for</span> <span class="n">xk</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pk_Vrtx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

            <span class="c1"># Merge mit MX</span>
            <span class="c1"># df=pd.merge(df,dfT,how=&#39;inner&#39;,left_on=&#39;mx2IdxVrtx&#39;,right_index=True)</span>

            <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mx2IdxVrtx&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># s errechnen</span>

            <span class="n">dfTmp</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="s1">&#39;LFDNR&#39;</span><span class="p">,</span> <span class="s1">&#39;XKOR&#39;</span><span class="p">,</span> <span class="s1">&#39;YKOR&#39;</span><span class="p">,</span> <span class="s1">&#39;ZKOR&#39;</span><span class="p">]]</span>

            <span class="n">dfTmp</span><span class="p">[</span><span class="s1">&#39;XKOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfTmp</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])[</span><span class="s1">&#39;XKOR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">periods</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dfTmp</span><span class="p">[</span><span class="s1">&#39;YKOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfTmp</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])[</span><span class="s1">&#39;YKOR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">periods</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dfTmp</span><span class="p">[</span><span class="s1">&#39;ZKOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfTmp</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])[</span><span class="s1">&#39;ZKOR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">periods</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">dfTmp</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;XKOR&#39;</span><span class="p">:</span> <span class="s1">&#39;DXKOR&#39;</span><span class="p">,</span> <span class="s1">&#39;YKOR&#39;</span><span class="p">:</span> <span class="s1">&#39;DYKOR&#39;</span><span class="p">,</span> <span class="s1">&#39;ZKOR&#39;</span><span class="p">:</span> <span class="s1">&#39;DZKOR&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">dfTmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;mx2IdxVrtx&#39;</span><span class="p">,</span> <span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;LFDNR&#39;</span><span class="p">,</span> <span class="s1">&#39;XKOR&#39;</span><span class="p">,</span> <span class="s1">&#39;YKOR&#39;</span><span class="p">,</span> <span class="s1">&#39;ZKOR&#39;</span><span class="p">]],</span> <span class="n">dfTmp</span><span class="p">[[</span>
                              <span class="s1">&#39;DXKOR&#39;</span><span class="p">,</span> <span class="s1">&#39;DYKOR&#39;</span><span class="p">,</span> <span class="s1">&#39;DZKOR&#39;</span><span class="p">]]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">dfTmp</span><span class="p">[</span><span class="s1">&#39;DXKOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfTmp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span>
                <span class="n">row</span><span class="o">.</span><span class="n">XKOR</span><span class="o">-</span><span class="n">row</span><span class="o">.</span><span class="n">DXKOR</span><span class="p">)</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">DXKOR</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dfTmp</span><span class="p">[</span><span class="s1">&#39;DYKOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfTmp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span>
                <span class="n">row</span><span class="o">.</span><span class="n">YKOR</span><span class="o">-</span><span class="n">row</span><span class="o">.</span><span class="n">DYKOR</span><span class="p">)</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">DYKOR</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dfTmp</span><span class="p">[</span><span class="s1">&#39;DZKOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfTmp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span>
                <span class="n">row</span><span class="o">.</span><span class="n">ZKOR</span><span class="o">-</span><span class="n">row</span><span class="o">.</span><span class="n">DZKOR</span><span class="p">)</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">DZKOR</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">dfTmp</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfTmp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span>
                <span class="n">row</span><span class="o">.</span><span class="n">DZKOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">DXKOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">DYKOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dfTmp</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfTmp</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;pk&#39;</span><span class="p">)[</span><span class="s1">&#39;ds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">dfTmp</span><span class="p">[[</span><span class="s1">&#39;s&#39;</span><span class="p">]]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Merge mit MX</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dfT</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span>
                          <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;mx2IdxVrtx&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">logStr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;_Done.&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">dbFileMutable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>       
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if dbFile is mutable</span>
<span class="sd">                </span>
<span class="sd">        :return: True/False       </span>
<span class="sd">        &quot;&quot;&quot;</span>           
        
        <span class="n">logStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">.</span><span class="si">{1:s}</span><span class="s2">: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;Start.&#39;</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbFile</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbFile</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>                    
                    <span class="c1"># das dbFile existiert und ist lesbar</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">dbFile: </span><span class="si">{:s}</span><span class="s2"> exists and is mutable&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">logStr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbFile</span><span class="p">))</span>                
                    <span class="k">return</span> <span class="kc">True</span>            
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">dbFile: </span><span class="si">{:s}</span><span class="s2"> exists but is not mutable&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">logStr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbFile</span><span class="p">))</span>                         
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">dbFile: </span><span class="si">{:s}</span><span class="s2"> not existing&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">logStr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbFile</span><span class="p">))</span>                         
                <span class="k">return</span> <span class="kc">False</span>                                       
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
           <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
               <span class="n">logStr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
           <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>    
        <span class="k">finally</span><span class="p">:</span>
           <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;_Done.&#39;</span><span class="p">))</span>                             


    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dfUpd</span><span class="p">,</span><span class="n">updInverseValue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>       
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates dbFile (SQLite only)</span>
<span class="sd">        </span>
<span class="sd">        :param dfUpd: df with update data </span>
<span class="sd">        :type dfUpd: df                 </span>
<span class="sd">        :param updInverseValue: value to use for attribValue for inverse objects  </span>
<span class="sd">        :type updInverseValue: ?, optional, default=None </span>
<span class="sd">        </span>
<span class="sd">        :return: rowsAffectedTotal</span>
<span class="sd">        </span>
<span class="sd">        .. note:: </span>
<span class="sd">            Comprehensive changes to model data should be made via the SIR 3S user interface. Or via the SIR 3S import interfaces which - depending on type/operation/parameterization - can also overwrite (update) existing model data. Nonetheless, scripted model changes can be helpful.</span>

<span class="sd">        .. note:: </span>
<span class="sd">            dfUpd&#39;s cols used:            </span>
<span class="sd">                - table i.e. &#39;FWVB&#39;</span>
<span class="sd">                - attrib i.e. &#39;W0&#39;</span>
<span class="sd">            dfUpd&#39;s cols optional:         </span>
<span class="sd">                - attribValue, default=dfUpd[attrib] </span>
<span class="sd">                - xk, default=&#39;tk&#39;</span>
<span class="sd">                - xkValue, default=dfUpd[xk] </span>
<span class="sd">            row-wise:</span>
<span class="sd">                - set attrib to attribValue in table where xk is xkValue</span>
<span class="sd">                - update an attribute of an object</span>
<span class="sd">            updInverseValue:</span>
<span class="sd">                - set attrib to updInverseValue for all objects of type table not mentioned in dfUpd                </span>
<span class="sd">        &quot;&quot;&quot;</span>           
        
        <span class="n">logStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">.</span><span class="si">{1:s}</span><span class="s2">: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;Start.&#39;</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbFileMutable</span><span class="p">():</span>            
                <span class="n">logStrFinal</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">dbFile: </span><span class="si">{:s}</span><span class="s2">: not existing or not mutable&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dbFile</span><span class="p">)</span>   
                <span class="k">raise</span> <span class="n">DxError</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>
                       
            <span class="n">dummy</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbFile</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ext</span> <span class="o">!=</span> <span class="s1">&#39;.db3&#39;</span><span class="p">:</span>
                 <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Function only implemented for SQLite (.db3)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">)</span>
                 <span class="k">raise</span> <span class="n">DxError</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>                
                           
            <span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbFile</span><span class="p">)</span>
            
            <span class="k">def</span> <span class="nf">updateFct</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="n">sql</span><span class="p">,</span><span class="n">OBJID</span><span class="p">,</span><span class="n">VALUE</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                &quot;&quot;&quot;</span>
                
                <span class="n">rowsAffected</span><span class="o">=</span><span class="kc">None</span>
                
                <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,(</span><span class="n">VALUE</span><span class="p">,</span><span class="n">OBJID</span><span class="p">))</span>
                <span class="n">rowsAffected</span><span class="o">=</span><span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span>
                <span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="k">return</span> <span class="n">rowsAffected</span>
                       
            <span class="n">dfUpd</span><span class="o">=</span><span class="n">dfUpd</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="n">cols</span><span class="o">=</span><span class="n">dfUpd</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;attribValue&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="n">dfUpd</span><span class="p">[</span><span class="s1">&#39;attribValue&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dfUpd</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;attrib&#39;</span><span class="p">]],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;xk&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="n">dfUpd</span><span class="p">[</span><span class="s1">&#39;xk&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;tk&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;xkValue&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="n">dfUpd</span><span class="p">[</span><span class="s1">&#39;xkValue&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dfUpd</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;xk&#39;</span><span class="p">]],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="n">rowsAffectedTotal</span><span class="o">=</span><span class="mi">0</span>  
            
            <span class="k">try</span><span class="p">:</span>                
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dfUpd</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">sqlCmd</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;UPDATE </span><span class="si">{table:s}</span><span class="s1"> SET </span><span class="si">{attrib:s}</span><span class="s1"> = ? WHERE </span><span class="si">{xk:s}</span><span class="s1"> = ?&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">],</span><span class="n">attrib</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;attrib&#39;</span><span class="p">],</span><span class="n">xk</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;xk&#39;</span><span class="p">])</span>
                    <span class="n">logStrSql</span><span class="o">=</span><span class="s2">&quot;sqlCmd: </span><span class="si">{sqlCmd:s}</span><span class="s2">:  attribValue:</span><span class="si">{attribValue:s}</span><span class="s2"> xkValue:</span><span class="si">{xkValue:s}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sqlCmd</span><span class="o">=</span><span class="n">sqlCmd</span><span class="p">,</span><span class="n">attribValue</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;attribValue&#39;</span><span class="p">]),</span><span class="n">xkValue</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;xkValue&#39;</span><span class="p">]))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span><span class="n">logStrSql</span><span class="p">))</span>
                    <span class="n">rowsAffected</span><span class="o">=</span><span class="n">updateFct</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="n">sqlCmd</span><span class="p">,</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;xkValue&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;attribValue&#39;</span><span class="p">])</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">rowsAffected: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">rowsAffected</span><span class="p">)))</span>
                    <span class="n">rowsAffectedTotal</span><span class="o">=</span><span class="n">rowsAffectedTotal</span><span class="o">+</span><span class="n">rowsAffected</span>
                    
                <span class="k">if</span> <span class="n">updInverseValue</span><span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    
                    <span class="k">for</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">attrib</span><span class="p">,</span><span class="n">xk</span><span class="p">),</span><span class="n">rowDummy</span> <span class="ow">in</span> <span class="n">dfUpd</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">,</span><span class="s1">&#39;attrib&#39;</span><span class="p">,</span><span class="s1">&#39;xk&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>                            
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">UpdInverse: </span><span class="si">{:s}</span><span class="s2"> </span><span class="si">{:s}</span><span class="s2"> </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span><span class="n">table</span><span class="p">,</span><span class="n">attrib</span><span class="p">,</span><span class="n">xk</span><span class="p">))</span>
                        <span class="n">tabDf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="n">table</span><span class="p">]</span>
                        <span class="n">tabDf</span><span class="o">=</span><span class="n">tabDf</span><span class="p">[</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">tabDf</span><span class="p">[</span><span class="n">xk</span><span class="p">])]</span>
                        <span class="n">tabDf</span><span class="o">=</span><span class="n">tabDf</span><span class="p">[</span><span class="o">~</span><span class="n">tabDf</span><span class="p">[</span><span class="n">xk</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;-1&#39;</span><span class="p">])]</span>
                        <span class="n">dfUpdInv</span><span class="o">=</span><span class="n">tabDf</span><span class="p">[</span><span class="o">~</span><span class="n">tabDf</span><span class="p">[</span><span class="n">xk</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dfUpd</span><span class="p">[</span><span class="s1">&#39;xkValue&#39;</span><span class="p">])]</span>
                    
                        <span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="n">dfUpdInv</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                             <span class="n">sqlCmd</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;UPDATE </span><span class="si">{table:s}</span><span class="s1"> SET </span><span class="si">{attrib:s}</span><span class="s1"> = ? WHERE </span><span class="si">{xk:s}</span><span class="s1"> = ?&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">,</span><span class="n">attrib</span><span class="o">=</span><span class="n">attrib</span><span class="p">,</span><span class="n">xk</span><span class="o">=</span><span class="n">xk</span><span class="p">)</span>
                             <span class="n">logStrSql</span><span class="o">=</span><span class="s2">&quot;sqlCmd: </span><span class="si">{sqlCmd:s}</span><span class="s2">: attribValue:</span><span class="si">{attribValue:s}</span><span class="s2"> xkValue:</span><span class="si">{xkValue:s}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sqlCmd</span><span class="o">=</span><span class="n">sqlCmd</span><span class="p">,</span><span class="n">attribValue</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">updInverseValue</span><span class="p">),</span><span class="n">xkValue</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">xk</span><span class="p">]))</span>
                             <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span><span class="n">logStrSql</span><span class="p">))</span>
                             <span class="n">rowsAffected</span><span class="o">=</span><span class="n">updateFct</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="n">sqlCmd</span><span class="p">,</span><span class="n">row</span><span class="p">[</span><span class="n">xk</span><span class="p">],</span><span class="n">updInverseValue</span><span class="p">)</span>
                             <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">rowsAffected: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">rowsAffected</span><span class="p">)))</span>
                             <span class="n">rowsAffectedTotal</span><span class="o">=</span><span class="n">rowsAffectedTotal</span><span class="o">+</span><span class="n">rowsAffected</span>
                                                    
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">logStr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="n">con</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="n">rowsAffectedTotal</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
           <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
               <span class="n">logStr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
           <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>
    
        <span class="k">finally</span><span class="p">:</span>
           <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;_Done.&#39;</span><span class="p">))</span>      
           <span class="c1">#return rowsAffectedTotal</span>
       
       
    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">table</span><span class="p">,</span><span class="n">dfIns</span><span class="p">,</span><span class="n">xkFct</span><span class="o">=</span><span class="n">fXk</span><span class="p">):</span>       
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inserts into a dbFile&#39;s table (SQLite only)</span>
<span class="sd">        </span>
<span class="sd">        :param table: table to insert to </span>
<span class="sd">        :type table: str </span>
<span class="sd">        :param dfIns: df with insert data </span>
<span class="sd">        :type dfIns: df   </span>
<span class="sd">        :param xkFct: func to call row-wise to obtain (pk, rk, tk) for an record to insert</span>
<span class="sd">        :type xkFct: func, optional, default=Dx.fXk      </span>
<span class="sd">        </span>
<span class="sd">        :return: rowsAffected, dfIns (a copy of dfIns; cols pk, rk, tk: inserted values; cols pkOrig, rkOrig, tkOrig: original values)</span>

<span class="sd">        .. note:: </span>
<span class="sd">            New model mass data should be created via the SIR 3S import interfaces. Nevertheless, generating model mass data via script can be helpful.</span>

<span class="sd">        .. note:: </span>
<span class="sd">            dfIns&#39; cols used:            </span>
<span class="sd">                - all cols which are also cols of table                </span>
<span class="sd">            row-wise:</span>
<span class="sd">                - insert into table                </span>
<span class="sd">        &quot;&quot;&quot;</span>           
        
        <span class="n">logStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">.</span><span class="si">{1:s}</span><span class="s2">: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;Start.&#39;</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbFileMutable</span><span class="p">():</span>            
                <span class="n">logStrFinal</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">dbFile: </span><span class="si">{:s}</span><span class="s2">: not existing or not mutable&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dbFile</span><span class="p">)</span>   
                <span class="k">raise</span> <span class="n">DxError</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>
                       
            <span class="n">dummy</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbFile</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ext</span> <span class="o">!=</span> <span class="s1">&#39;.db3&#39;</span><span class="p">:</span>
                 <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Function only implemented for SQLite (.db3)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">)</span>
                 <span class="k">raise</span> <span class="n">DxError</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>             
            

            <span class="n">rowsAffected</span><span class="o">=</span><span class="kc">None</span>
                                       
            <span class="n">dfToIns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="n">table</span><span class="p">]</span>
            <span class="n">cols</span><span class="o">=</span><span class="n">dfToIns</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="n">colList</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">colList</span><span class="o">=</span><span class="n">colList</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="n">col</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;INSERT OR REPLACE INTO </span><span class="si">{table:s}</span><span class="s1"> VALUES(</span><span class="si">{colList:s}</span><span class="s1">)&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">,</span><span class="n">colList</span><span class="o">=</span><span class="n">colList</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">sql: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span><span class="n">sql</span><span class="p">))</span>
            
            <span class="c1"># Kopie der einzufuegenden Zeilen</span>
            <span class="n">dfIns</span><span class="o">=</span><span class="n">dfIns</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># # Original-Xks merken</span>
            <span class="c1"># for col in [&#39;pk&#39;,&#39;rk&#39;,&#39;tk&#39;]:</span>
            <span class="c1">#     if col in cols:</span>
            <span class="c1">#         dfIns[col+&#39;Orig&#39;]=dfIns[col]</span>
            
            <span class="n">data</span><span class="o">=</span><span class="n">dfIns</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
            
            <span class="c1"># Original-Xks merken</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">,</span><span class="s1">&#39;rk&#39;</span><span class="p">,</span><span class="s1">&#39;tk&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                    <span class="n">dfIns</span><span class="p">[</span><span class="n">col</span><span class="o">+</span><span class="s1">&#39;Orig&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dfIns</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>            
            
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">recordDct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>            
                <span class="n">row</span><span class="o">=</span><span class="n">dfIns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,:]</span>
                <span class="p">(</span><span class="n">pk</span><span class="p">,</span><span class="n">rk</span><span class="p">,</span><span class="n">tk</span><span class="p">)</span><span class="o">=</span><span class="n">xkFct</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">xkValue</span><span class="p">,</span><span class="n">xkCol</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="n">pk</span><span class="p">,</span><span class="n">rk</span><span class="p">,</span><span class="n">tk</span><span class="p">),[</span><span class="s1">&#39;pk&#39;</span><span class="p">,</span><span class="s1">&#39;rk&#39;</span><span class="p">,</span><span class="s1">&#39;tk&#39;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">xkCol</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                        <span class="c1"># Xks setzen </span>
                        <span class="n">recordDct</span><span class="p">[</span><span class="n">xkCol</span><span class="p">]</span><span class="o">=</span><span class="n">xkValue</span>  
                        <span class="c1"># Xks merken</span>
                        <span class="n">dfIns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="n">xkCol</span><span class="p">]</span><span class="o">=</span><span class="n">xkValue</span> 
            <span class="n">data</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>   
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">data: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
                                
            <span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbFile</span><span class="p">)</span>
            
            <span class="k">def</span> <span class="nf">insertFct</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="n">sql</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                &quot;&quot;&quot;</span>
                
                <span class="n">rowsAffected</span><span class="o">=</span><span class="kc">None</span>
                
                <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                <span class="n">cur</span><span class="o">=</span><span class="n">cur</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="n">rowsAffected</span><span class="o">=</span><span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span>
                <span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            
                <span class="k">return</span> <span class="n">rowsAffected</span>            
                                    
            <span class="k">try</span><span class="p">:</span>                                
                <span class="n">rowsAffected</span><span class="o">=</span><span class="n">insertFct</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="n">sql</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>                                                      
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">logStr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="n">con</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="n">rowsAffected</span><span class="p">,</span><span class="n">dfIns</span> 

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
           <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
               <span class="n">logStr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
           <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>
    
        <span class="k">finally</span><span class="p">:</span>
           <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;_Done.&#39;</span><span class="p">))</span>      
           <span class="c1">#return rowsAffected        </span>

    <span class="k">def</span> <span class="nf">importFromSIR3S</span><span class="p">(</span><span class="bp">self</span>
                        <span class="p">,</span><span class="n">dbSrc</span>
                        <span class="p">,</span><span class="n">tablesToImport</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;STRASSE&#39;</span><span class="p">,</span><span class="s1">&#39;LTGR&#39;</span><span class="p">,</span><span class="s1">&#39;DTRO&#39;</span><span class="p">,</span><span class="s1">&#39;DTRO_ROWD&#39;</span><span class="p">,</span><span class="s1">&#39;KNOT&#39;</span><span class="p">,</span><span class="s1">&#39;KNOT_BZ&#39;</span><span class="p">,</span><span class="s1">&#39;ROHR&#39;</span><span class="p">,</span><span class="s1">&#39;ROHR_BZ&#39;</span><span class="p">,</span><span class="s1">&#39;FWVB&#39;</span><span class="p">,</span><span class="s1">&#39;FWVB_BZ&#39;</span><span class="p">,</span><span class="s1">&#39;LAYR&#39;</span><span class="p">]</span>
                        <span class="p">,</span><span class="n">fksNotToFillWithDstTemplateValues</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fkKI&#39;</span><span class="p">,</span><span class="s1">&#39;fkKK&#39;</span><span class="p">,</span><span class="s1">&#39;fkDTRO_ROWD&#39;</span><span class="p">,</span><span class="s1">&#39;fkLTGR&#39;</span><span class="p">,</span><span class="s1">&#39;fkSTRASSE&#39;</span><span class="p">]</span>
                        <span class="p">,</span><span class="n">fctsToCall</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;*&#39;</span><span class="p">:</span><span class="n">fimportFromSIR3S</span><span class="p">}</span>
                        <span class="p">,</span><span class="n">fctsToCallLogging</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">):</span>       
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Import data from an other SIR 3S Model (SQLite only)</span>
<span class="sd">        </span>
<span class="sd">        :param dbSrc: SIR 3S dbFile to import from</span>
<span class="sd">        :type dbSrc: str </span>
<span class="sd">        :param tablesToImport: tabNames to import from</span>
<span class="sd">        :type tablesToImport: list of tabNames, optional, default=[&#39;STRASSE&#39;,&#39;LTGR&#39;,&#39;DTRO&#39;,&#39;DTRO_ROWD&#39;</span>
<span class="sd">                                                                   ,&#39;KNOT&#39;,&#39;KNOT_BZ&#39;,&#39;ROHR&#39;,&#39;ROHR_BZ&#39;,&#39;FWVB&#39;,&#39;FWVB_BZ&#39;</span>
<span class="sd">                                                                   ,&#39;LAYR&#39;]</span>
<span class="sd">        :param fksNotToFillWithDstTemplateValues: colNames starting with fk not to set to the corresponding Dst-Template-Value</span>
<span class="sd">        :type fksNotToFillWithDstTemplateValues: list of fk starting colNames, optional, default=[&#39;fkKI&#39;,&#39;fkKK&#39;,&#39;fkDTRO_ROWD&#39;,&#39;fkLTGR&#39;,&#39;fkSTRASSE&#39;]</span>
<span class="sd">        :param fctsToCall: dct of functions to call before import</span>
<span class="sd">        :type fctsToCall: dct of functions, optional, default={&#39;*&#39;:fimportFromSIR3S}; f(&#39;*&#39;) is called if defined and then the object-specific f(OBJ) is called if defined</span>
<span class="sd">        :param fctsToCallLogging: decide if fctsToCall shall generate Log-Output</span>
<span class="sd">        :type fctsToCallLogging: bool, optional, default=True</span>
<span class="sd">        </span>
<span class="sd">        .. note:: </span>
<span class="sd">            Model data from annother SIR 3S Model should be imported via the SIR 3S export/import interfaces. </span>
<span class="sd">            I.e. export in Src Sdf/Csv, import in Dst the exported Sdf/Csv. Or copy in Src and paste in Dst. Or export/import SIR 3S Blocks. </span>
<span class="sd">            Nevertheless, importing from another Model via script can be helpful.</span>

<span class="sd">        .. note::              </span>
<span class="sd">            Template-Objects are Objects with col &#39;KENNUNG&#39; &lt; 0.</span>
<span class="sd">            Template-Objects are not copied from Src to Dst.</span>
<span class="sd">            For objects with Templates defined all Non-Null fk-Starting Template-Attributes from Dst are set except for: fksNotToFillWithDstTemplateValues.</span>
<span class="sd">            It follows that i.e. for KNOT(_BZ), ROHR(_BZ), FWVB(_BZ) fkDE is set to the corresponding fkDE Dst-Template-Attribute if defined.</span>
<span class="sd">            For all objects fkDE is finally set to fkBASIS(fkBZ) of the SYSTEMKONFIG(3)-Model if SYSTEMKONFIG(3) is defined.</span>
<span class="sd">            </span>
<span class="sd">        .. note::              </span>
<span class="sd">            Dst and Src: SIR 3S Version and CRS (coordinate reference system) should be identical, QGIS-Export should be done (to ensure correct and matching GEOMWKBs in Dst and Src).          </span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>           
        
        <span class="n">logStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">.</span><span class="si">{1:s}</span><span class="s2">: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;Start.&#39;</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            
            <span class="n">SrcDb</span><span class="o">=</span><span class="n">dbSrc</span>
            <span class="n">engineSrc</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;sqlite:///&quot;</span><span class="o">+</span><span class="n">SrcDb</span><span class="p">)</span>
            <span class="n">BaseSrc</span> <span class="o">=</span> <span class="n">automap_base</span><span class="p">()</span>      
            <span class="n">BaseSrc</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">autoload_with</span><span class="o">=</span><span class="n">engineSrc</span><span class="p">)</span>
            <span class="n">sessionSrc</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">engineSrc</span><span class="p">)</span>
            
            <span class="n">OBJsSrc</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tablesToImport</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">BaseSrc</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">==</span><span class="n">c</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                        <span class="n">OBJsSrc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>                    
                        <span class="k">break</span>
            <span class="c1">#OBJsSrc=[BaseSrc.classes.STRASSE,BaseSrc.classes.LTGR,BaseSrc.classes.DTRO,BaseSrc.classes.DTRO_ROWD,BaseSrc.classes.KNOT,BaseSrc.classes.KNOT_BZ,BaseSrc.classes.ROHR,BaseSrc.classes.ROHR_BZ,BaseSrc.classes.FWVB,BaseSrc.classes.FWVB_BZ,BaseSrc.classes.LAYR]</span>
            
            <span class="n">engineDst</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;sqlite:///&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dbFile</span><span class="p">)</span>
            <span class="n">BaseDst</span> <span class="o">=</span> <span class="n">automap_base</span><span class="p">()</span>
            <span class="n">BaseDst</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">autoload_with</span><span class="o">=</span><span class="n">engineDst</span><span class="p">)</span>
            <span class="n">sessionDst</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">engineDst</span><span class="p">)</span>     
            
            <span class="n">OBJsDst</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tablesToImport</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">BaseDst</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">==</span><span class="n">c</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                        <span class="n">OBJsDst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>                          
                        <span class="k">break</span>
            <span class="c1">#OBJsDst=[BaseDst.classes.STRASSE,BaseDst.classes.LTGR,BaseDst.classes.DTRO,BaseDst.classes.DTRO_ROWD,BaseDst.classes.KNOT,BaseDst.classes.KNOT_BZ,BaseDst.classes.ROHR,BaseDst.classes.ROHR_BZ,BaseDst.classes.FWVB,BaseDst.classes.FWVB_BZ,BaseDst.classes.LAYR]</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">QGISmodelXk</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s1">&#39;fkBASIS,fkBZ from VIEW_MODELLE where pk=</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">QGISmodelXk</span><span class="p">)))</span>
                <span class="c1">#print(stmt)</span>
                
                <span class="k">with</span> <span class="n">engineDst</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="c1">#print(row)</span>
                        <span class="k">break</span>
                <span class="p">(</span><span class="n">fkBASIS</span><span class="p">,</span><span class="n">fkBZ</span><span class="p">)</span><span class="o">=</span><span class="n">row</span>   
                <span class="c1">#print((fkBASIS,fkBZ))   </span>
            
            <span class="c1">#fksNotFilledWithTemplateValues=[&#39;fkKI&#39;,&#39;fkKK&#39;,&#39;fkDTRO_ROWD&#39;,&#39;fkLTGR&#39;,&#39;fkSTRASSE&#39;]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">QGISmodelXk</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fksNotToFillWithDstTemplateValues</span><span class="o">=</span><span class="n">fksNotToFillWithDstTemplateValues</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;fkDE&#39;</span><span class="p">]</span>
                
            <span class="c1"># Template Handling    </span>
            <span class="n">OBJDstTemplates</span><span class="o">=</span><span class="p">{}</span>
            <span class="k">for</span> <span class="n">OBJSrc</span><span class="p">,</span><span class="n">OBJDst</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">OBJsSrc</span><span class="p">,</span><span class="n">OBJsDst</span><span class="p">):</span>
                <span class="n">objTYPE</span><span class="o">=</span><span class="n">OBJSrc</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">name</span>
                <span class="c1">#print(objTYPE)</span>
                
                <span class="n">OBJDstcols</span><span class="o">=</span><span class="p">[</span><span class="n">column</span><span class="o">.</span><span class="n">key</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">OBJDst</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>    
                <span class="k">if</span> <span class="s1">&#39;KENNUNG&#39;</span> <span class="ow">in</span> <span class="n">OBJDstcols</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">objTemplateDst</span> <span class="ow">in</span> <span class="n">sessionDst</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OBJDst</span><span class="p">)</span> \
                        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OBJDst</span><span class="o">.</span><span class="n">KENNUNG</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>
                        <span class="c1">#logger.debug(f&quot;{logStr}{objTYPE}: Template Handling: ...&quot;)</span>
                        <span class="k">break</span> <span class="c1"># das erste gefundene Template dient als Vorlage</span>
                
                    <span class="n">objTemplateDstfkAttribs</span><span class="o">=</span><span class="p">[]</span>
                    <span class="n">objTemplateSrcpks</span><span class="o">=</span><span class="p">[]</span>
                    
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">objTemplateDst</span><span class="p">,</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="ow">not</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">a</span><span class="p">))):</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;^_&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="nb">float</span><span class="p">))</span> <span class="p">:</span>
                            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;^fk&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span> 
                                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fksNotToFillWithDstTemplateValues</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">logStr</span><span class="si">}{</span><span class="n">objTYPE</span><span class="si">:</span><span class="s2">12s</span><span class="si">}</span><span class="s2">: Template Handling: attr: </span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">12s</span><span class="si">}</span><span class="s2"> will be set to Dst-Template-value: </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">objTemplateDst</span><span class="p">,</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                    <span class="c1">#print(name,getattr(objTemplateDst,name))</span>
                                    <span class="n">objTemplateDstfkAttribs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>    
                    
                    <span class="k">for</span> <span class="n">objTemplateSrc</span> <span class="ow">in</span> <span class="n">sessionSrc</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OBJSrc</span><span class="p">)</span> \
                        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OBJSrc</span><span class="o">.</span><span class="n">KENNUNG</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>
                        <span class="n">objTemplateSrcpks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">objTemplateSrc</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span> <span class="c1"># pks aller Template-Objekte merken</span>
                    
                    <span class="n">OBJDstTemplates</span><span class="p">[</span><span class="n">objTYPE</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">OBJDstcols</span><span class="p">,</span><span class="n">objTemplateDst</span><span class="p">,</span><span class="n">objTemplateDstfkAttribs</span><span class="p">,</span><span class="n">objTemplateSrcpks</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>                     
                    
            <span class="c1"># Templates in BZ-Tabellen finden          </span>
            <span class="k">for</span> <span class="n">OBJSrc</span><span class="p">,</span><span class="n">OBJDst</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">OBJsSrc</span><span class="p">,</span><span class="n">OBJsDst</span><span class="p">):</span>
                <span class="n">objTYPE</span><span class="o">=</span><span class="n">OBJSrc</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">name</span>
                <span class="c1">#print(objTYPE)</span>
                
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;_BZ$&#39;</span><span class="p">,</span><span class="n">objTYPE</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span> <span class="c1"># keine BZ-Tabelle</span>
                
                <span class="n">BobjType</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_BZ$&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">objTYPE</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">BobjType</span> <span class="ow">in</span> <span class="n">OBJDstTemplates</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    
                    <span class="c1">#print(objTYPE,BobjType)</span>
                    <span class="k">pass</span> 
                    
                    <span class="p">(</span><span class="n">OBJDstcols</span><span class="p">,</span><span class="n">objTemplateDst</span><span class="p">,</span><span class="n">objTemplateDstfkAttribs</span><span class="p">,</span><span class="n">objTemplateSrcpks</span><span class="p">,</span><span class="n">dummy</span><span class="p">)</span> <span class="o">=</span>  <span class="n">OBJDstTemplates</span><span class="p">[</span><span class="n">BobjType</span><span class="p">]</span>     
                    
                    <span class="k">for</span> <span class="n">objTemplateDstBZ</span> <span class="ow">in</span> <span class="n">sessionSrc</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OBJSrc</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OBJSrc</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">not_in</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;-1&#39;</span><span class="p">]))</span>\
                        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OBJSrc</span><span class="o">.</span><span class="n">fk</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">objTemplateSrcpks</span><span class="p">)):</span>
                        <span class="k">pass</span>
                        <span class="c1">#print(&#39;Template&#39;)</span>
                        <span class="k">break</span> <span class="c1"># das erste gefundene Template dient als Vorlage       </span>
                    
                    <span class="n">OBJDstTemplates</span><span class="p">[</span><span class="n">BobjType</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">OBJDstcols</span><span class="p">,</span><span class="n">objTemplateDst</span><span class="p">,</span><span class="n">objTemplateDstfkAttribs</span><span class="p">,</span><span class="n">objTemplateSrcpks</span><span class="p">,</span><span class="n">objTemplateDstBZ</span><span class="p">)</span>
             
            <span class="c1"># Copy</span>
            <span class="k">for</span> <span class="n">OBJSrc</span><span class="p">,</span><span class="n">OBJDst</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">OBJsSrc</span><span class="p">,</span><span class="n">OBJsDst</span><span class="p">):</span>
                
                <span class="n">objTYPE</span><span class="o">=</span><span class="n">OBJSrc</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">name</span>
                <span class="c1">#print(objTYPE)</span>
                    
                <span class="n">OBJSrccols</span><span class="o">=</span><span class="p">[</span><span class="n">column</span><span class="o">.</span><span class="n">key</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">OBJSrc</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>    
                    
                <span class="k">if</span> <span class="n">objTYPE</span> <span class="ow">in</span> <span class="n">OBJDstTemplates</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c1"># table has templates</span>
               
                    <span class="p">(</span><span class="n">OBJDstcols</span><span class="p">,</span><span class="n">objTemplateDst</span><span class="p">,</span><span class="n">objTemplateDstfkAttribs</span><span class="p">,</span><span class="n">objTemplateSrcpks</span><span class="p">,</span><span class="n">dummy</span><span class="p">)</span> <span class="o">=</span>  <span class="n">OBJDstTemplates</span><span class="p">[</span><span class="n">objTYPE</span><span class="p">]</span>     
                    
                    <span class="c1">#logger.debug(f&quot;{logStr}{objTYPE:12s}: Template Handling: attrs: {objTemplateDstfkAttribs} will be set to Template-values ...&quot;)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">QGISmodelXk</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">logStr</span><span class="si">}{</span><span class="n">objTYPE</span><span class="si">:</span><span class="s2">12s</span><span class="si">}</span><span class="s2">: attr: fkDE will be set to fkBASIS: </span><span class="si">{</span><span class="n">fkBASIS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>    
            
                    <span class="n">objDstPks</span><span class="o">=</span><span class="p">[]</span>
                    <span class="k">for</span> <span class="n">objDst</span> <span class="ow">in</span> <span class="n">sessionDst</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OBJDst</span><span class="p">):</span>
                        <span class="n">objDstPks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">objDst</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span> <span class="c1"># pks in Ziel-DB merken             </span>
                        
                    <span class="n">q1</span><span class="o">=</span><span class="n">sessionSrc</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OBJSrc</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OBJSrc</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">not_in</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;-1&#39;</span><span class="p">]))</span>
                    <span class="n">q2</span><span class="o">=</span><span class="n">q1</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">or_</span><span class="p">(</span><span class="n">OBJSrc</span><span class="o">.</span><span class="n">KENNUNG</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">OBJSrc</span><span class="o">.</span><span class="n">KENNUNG</span> <span class="o">==</span> <span class="kc">None</span><span class="p">))</span>
                    <span class="n">q</span><span class="o">=</span><span class="n">q2</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OBJSrc</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">not_in</span><span class="p">(</span><span class="n">objDstPks</span><span class="p">))</span>
                    
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">logStr</span><span class="si">}{</span><span class="n">objTYPE</span><span class="si">:</span><span class="s2">12s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">q</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2"> to copy (not copied because Templates: </span><span class="si">{</span><span class="n">q1</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">-</span><span class="n">q2</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2">) (not to copy because pk exists already in Dst: </span><span class="si">{</span><span class="n">q2</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">-</span><span class="n">q</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>                                         
                    
                    <span class="c1">#for objSrc in sessionSrc.query(OBJSrc) \</span>
                    <span class="c1">#    .filter(or_(OBJSrc.KENNUNG&gt;0, OBJSrc.KENNUNG == None))\</span>
                    <span class="c1">#    .filter(OBJSrc.pk.not_in([-1,&#39;-1&#39;])):</span>
                        
                    <span class="k">for</span> <span class="n">objSrc</span> <span class="ow">in</span> <span class="n">q</span><span class="p">:</span>                        
                        
                        <span class="n">objDst</span><span class="o">=</span><span class="n">OBJDst</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">OBJSrccols</span><span class="p">:</span>                
                            <span class="nb">setattr</span><span class="p">(</span><span class="n">objDst</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="nb">getattr</span><span class="p">(</span><span class="n">objSrc</span><span class="p">,</span><span class="n">attr</span><span class="p">))</span>                
                                            
                        <span class="c1"># override Src-values with Dst-values for all template-attributes   </span>
                        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">objTemplateDstfkAttribs</span><span class="p">:</span>                
                            <span class="nb">setattr</span><span class="p">(</span><span class="n">objDst</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="nb">getattr</span><span class="p">(</span><span class="n">objTemplateDst</span><span class="p">,</span><span class="n">attr</span><span class="p">))</span>
                            
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">QGISmodelXk</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                             <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fkDE&#39;</span><span class="p">]:</span>
                                <span class="nb">setattr</span><span class="p">(</span><span class="n">objDst</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="n">fkBASIS</span><span class="p">)</span>
                                
                        <span class="n">toImport</span><span class="o">=</span><span class="kc">True</span>
                        <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">fctsToCall</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="p">(</span><span class="n">objDst</span><span class="p">,</span><span class="n">toImport</span><span class="p">)</span><span class="o">=</span><span class="n">fctsToCall</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span><span class="n">OBJSrc</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">objSrc</span><span class="p">,</span><span class="n">objDst</span><span class="p">,</span><span class="n">fctsToCallLogging</span><span class="p">)</span>                                
                        <span class="k">if</span> <span class="n">objTYPE</span> <span class="ow">in</span> <span class="n">fctsToCall</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">toImport</span><span class="p">:</span>
                            <span class="p">(</span><span class="n">objDst</span><span class="p">,</span><span class="n">toImport</span><span class="p">)</span><span class="o">=</span><span class="n">fctsToCall</span><span class="p">[</span><span class="n">objTYPE</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span><span class="n">OBJSrc</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">objSrc</span><span class="p">,</span><span class="n">objDst</span><span class="p">,</span><span class="n">fctsToCallLogging</span><span class="p">)</span>                                    
                        <span class="k">if</span> <span class="n">toImport</span><span class="p">:</span>
                            <span class="n">sessionDst</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">objDst</span><span class="p">)</span>                                                                                                                                 
                    
                <span class="k">else</span><span class="p">:</span>  
                    <span class="n">BobjType</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_BZ$&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">objTYPE</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">BobjType</span> <span class="ow">in</span> <span class="n">OBJDstTemplates</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">pass</span> <span class="c1"># table maybe references templates</span>
                    
                        <span class="p">(</span><span class="n">OBJDstcols</span><span class="p">,</span><span class="n">objTemplateDst</span><span class="p">,</span><span class="n">objTemplateDstfkAttribs</span><span class="p">,</span><span class="n">objTemplateSrcpks</span><span class="p">,</span><span class="n">objTemplateDstBZ</span><span class="p">)</span> <span class="o">=</span>  <span class="n">OBJDstTemplates</span><span class="p">[</span><span class="n">BobjType</span><span class="p">]</span>     
                        
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">QGISmodelXk</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">logStr</span><span class="si">}{</span><span class="n">objTYPE</span><span class="si">:</span><span class="s2">12s</span><span class="si">}</span><span class="s2">: attr: fkDE will be set to fkBZ   : </span><span class="si">{</span><span class="n">fkBZ</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>    
                    
                    
                        <span class="n">objDstPks</span><span class="o">=</span><span class="p">[]</span>
                        <span class="k">for</span> <span class="n">objDst</span> <span class="ow">in</span> <span class="n">sessionDst</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OBJDst</span><span class="p">):</span>
                            <span class="n">objDstPks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">objDst</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span> <span class="c1"># pks in Ziel-DB merken   </span>
                                        
                        <span class="n">q1</span><span class="o">=</span><span class="n">sessionSrc</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OBJSrc</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OBJSrc</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">not_in</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;-1&#39;</span><span class="p">]))</span>                        
                        <span class="n">q2</span><span class="o">=</span><span class="n">q1</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OBJSrc</span><span class="o">.</span><span class="n">fk</span><span class="o">.</span><span class="n">not_in</span><span class="p">(</span><span class="n">objTemplateSrcpks</span><span class="p">))</span>
                        <span class="n">q</span><span class="o">=</span><span class="n">q2</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OBJSrc</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">not_in</span><span class="p">(</span><span class="n">objDstPks</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">logStr</span><span class="si">}{</span><span class="n">objTYPE</span><span class="si">:</span><span class="s2">12s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">q</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2"> to copy (not to copy because (referencing) Templates: </span><span class="si">{</span><span class="n">q1</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">-</span><span class="n">q2</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2">) (not to copy because pk exists already in Dst: </span><span class="si">{</span><span class="n">q2</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">-</span><span class="n">q</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>                     
                    
                        <span class="c1">#for objSrc in sessionSrc.query(OBJSrc).filter(OBJSrc.pk.not_in([-1,&#39;-1&#39;]))\</span>
                        <span class="c1">#.filter(OBJSrc.fk.not_in(objTemplateSrcpks)):</span>
            
                        <span class="k">for</span> <span class="n">objSrc</span> <span class="ow">in</span> <span class="n">q</span><span class="p">:</span>
                            <span class="n">objDst</span><span class="o">=</span><span class="n">OBJDst</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">OBJSrccols</span><span class="p">:</span>                
                                <span class="nb">setattr</span><span class="p">(</span><span class="n">objDst</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="nb">getattr</span><span class="p">(</span><span class="n">objSrc</span><span class="p">,</span><span class="n">attr</span><span class="p">))</span>                
                    
                            <span class="c1">#for attr in [&#39;fkDE&#39;]:                    </span>
                            <span class="c1">#    setattr(objDst,attr,getattr(objTemplateDstBZ,attr))        </span>
                                
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">QGISmodelXk</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                                 <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fkDE&#39;</span><span class="p">]:</span>
                                    <span class="nb">setattr</span><span class="p">(</span><span class="n">objDst</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="n">fkBZ</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                 <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fkDE&#39;</span><span class="p">]:</span>                    
                                    <span class="nb">setattr</span><span class="p">(</span><span class="n">objDst</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="nb">getattr</span><span class="p">(</span><span class="n">objTemplateDstBZ</span><span class="p">,</span><span class="n">attr</span><span class="p">))</span>      
                                    
                                    
                            <span class="n">toImport</span><span class="o">=</span><span class="kc">True</span>
                            <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">fctsToCall</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="p">(</span><span class="n">objDst</span><span class="p">,</span><span class="n">toImport</span><span class="p">)</span><span class="o">=</span><span class="n">fctsToCall</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span><span class="n">OBJSrc</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">objSrc</span><span class="p">,</span><span class="n">objDst</span><span class="p">,</span><span class="n">fctsToCallLogging</span><span class="p">)</span>                                
                            <span class="k">if</span> <span class="n">objTYPE</span> <span class="ow">in</span> <span class="n">fctsToCall</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">toImport</span><span class="p">:</span>
                                <span class="p">(</span><span class="n">objDst</span><span class="p">,</span><span class="n">toImport</span><span class="p">)</span><span class="o">=</span><span class="n">fctsToCall</span><span class="p">[</span><span class="n">objTYPE</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span><span class="n">OBJSrc</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">objSrc</span><span class="p">,</span><span class="n">objDst</span><span class="p">,</span><span class="n">fctsToCallLogging</span><span class="p">)</span>                                    
                            <span class="k">if</span> <span class="n">toImport</span><span class="p">:</span>
                                <span class="n">sessionDst</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">objDst</span><span class="p">)</span>                                     
                                                                                                            
                    <span class="k">else</span><span class="p">:</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">QGISmodelXk</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">logStr</span><span class="si">}{</span><span class="n">objTYPE</span><span class="si">:</span><span class="s2">12s</span><span class="si">}</span><span class="s2">: attr: fkDE will be set to fkBASIS: </span><span class="si">{</span><span class="n">fkBASIS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>                            
 
                        <span class="n">objDstPks</span><span class="o">=</span><span class="p">[]</span>
                        <span class="k">for</span> <span class="n">objDst</span> <span class="ow">in</span> <span class="n">sessionDst</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OBJDst</span><span class="p">):</span>
                            <span class="n">objDstPks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">objDst</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span> <span class="c1"># pks in Ziel-DB merken            </span>
                        
                        <span class="n">q1</span><span class="o">=</span><span class="n">sessionSrc</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OBJSrc</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OBJSrc</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">not_in</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;-1&#39;</span><span class="p">]))</span>                        
                        <span class="n">q</span><span class="o">=</span><span class="n">q1</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">OBJSrc</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">not_in</span><span class="p">(</span><span class="n">objDstPks</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">logStr</span><span class="si">}{</span><span class="n">objTYPE</span><span class="si">:</span><span class="s2">12s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">q</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2"> to copy (not to copy because pk exists already in Dst: </span><span class="si">{</span><span class="n">q1</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">-</span><span class="n">q</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span> 
                        <span class="k">for</span> <span class="n">objSrc</span> <span class="ow">in</span> <span class="n">q</span><span class="p">:</span>
            
                            <span class="n">objDst</span><span class="o">=</span><span class="n">OBJDst</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">OBJSrccols</span><span class="p">:</span>                
                                <span class="nb">setattr</span><span class="p">(</span><span class="n">objDst</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="nb">getattr</span><span class="p">(</span><span class="n">objSrc</span><span class="p">,</span><span class="n">attr</span><span class="p">))</span>     
                                
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">QGISmodelXk</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                                 <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fkDE&#39;</span><span class="p">]:</span>
                                    <span class="nb">setattr</span><span class="p">(</span><span class="n">objDst</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="n">fkBASIS</span><span class="p">)</span>
                                    
                            <span class="n">toImport</span><span class="o">=</span><span class="kc">True</span>
                            <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">fctsToCall</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="p">(</span><span class="n">objDst</span><span class="p">,</span><span class="n">toImport</span><span class="p">)</span><span class="o">=</span><span class="n">fctsToCall</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span><span class="n">OBJSrc</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">objSrc</span><span class="p">,</span><span class="n">objDst</span><span class="p">,</span><span class="n">fctsToCallLogging</span><span class="p">)</span>                                
                            <span class="k">if</span> <span class="n">objTYPE</span> <span class="ow">in</span> <span class="n">fctsToCall</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">toImport</span><span class="p">:</span>
                                <span class="p">(</span><span class="n">objDst</span><span class="p">,</span><span class="n">toImport</span><span class="p">)</span><span class="o">=</span><span class="n">fctsToCall</span><span class="p">[</span><span class="n">objTYPE</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span><span class="n">OBJSrc</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">objSrc</span><span class="p">,</span><span class="n">objDst</span><span class="p">,</span><span class="n">fctsToCallLogging</span><span class="p">)</span>                                    
                            <span class="k">if</span> <span class="n">toImport</span><span class="p">:</span>
                                <span class="n">sessionDst</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">objDst</span><span class="p">)</span>            
                    
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">logStr</span><span class="si">}{</span><span class="n">objTYPE</span><span class="si">:</span><span class="s2">12s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sessionDst</span><span class="o">.</span><span class="n">new</span><span class="p">)</span><span class="si">}</span><span class="s2"> queued to copy (not queued because fctsToCall: </span><span class="si">{</span><span class="n">q</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">sessionDst</span><span class="o">.</span><span class="n">new</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="n">sessionDst</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            
            <span class="n">sessionDst</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">sessionSrc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
           <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
               <span class="n">logStr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
           <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>
    
        <span class="k">finally</span><span class="p">:</span>
           <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;_Done.&#39;</span><span class="p">))</span>



    <span class="k">def</span> <span class="nf">setLayerContentTo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">layerName</span><span class="p">,</span><span class="n">df</span><span class="p">):</span>          
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates content of layerName to df&#39;s-content</span>
<span class="sd">        </span>
<span class="sd">        :param layerName: name of an existing layer</span>
<span class="sd">        :type layerName: str</span>
<span class="sd">        </span>
<span class="sd">        :return: rowsAffected</span>
<span class="sd">        </span>
<span class="sd">        .. note:: </span>
<span class="sd">            Groups or layers are used in SIR 3S as a feature for data access, data filtering and grouping. The assignment of objects to groups should be done (explicit) via the SIR 3S user interface or (implicit) via the SIR 3S import interfaces. Nonetheless, scripted assignment can be useful.</span>

<span class="sd">        .. note:: </span>
<span class="sd">            df&#39;s cols used:            </span>
<span class="sd">                - TYPE </span>
<span class="sd">                - ID                 </span>
<span class="sd">        &quot;&quot;&quot;</span>           
                
        <span class="n">logStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">.</span><span class="si">{1:s}</span><span class="s2">: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span><span class="s1">&#39;Start.&#39;</span><span class="p">))</span> 
        
        <span class="k">try</span><span class="p">:</span> 
            
            <span class="n">rowsAffected</span><span class="o">=</span><span class="kc">None</span>
            
            <span class="n">layr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataFrames</span><span class="p">[</span><span class="s1">&#39;LAYR&#39;</span><span class="p">]</span>            
            <span class="n">dfTmp</span><span class="o">=</span><span class="n">layr</span><span class="p">[</span><span class="n">layr</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">layerName</span><span class="p">])]</span>
                        
            <span class="k">if</span> <span class="n">dfTmp</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>                
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">Layer </span><span class="si">{1:s}</span><span class="s2"> not existing. Maybe (Re-)Processing the dbFile to Dx is necessary...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span><span class="n">layerName</span><span class="p">))</span> 
            <span class="k">elif</span> <span class="n">dfTmp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">LayerName </span><span class="si">{1:s}</span><span class="s2">: matching rows: </span><span class="si">{2:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span><span class="n">layerName</span><span class="p">,</span><span class="n">dfTmp</span><span class="o">.</span><span class="n">to_string</span><span class="p">()))</span>                 
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">Layer(name) </span><span class="si">{1:s}</span><span class="s2"> not unique: No Updates ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span><span class="n">layerName</span><span class="p">))</span> 
            <span class="k">else</span><span class="p">:</span>
            
                <span class="c1">###xk=dfTmp[&#39;tk&#39;].iloc[0]</span>
                
                
                <span class="n">dfUpd</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
                <span class="n">dfUpd</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;LAYR&#39;</span>
                <span class="n">dfUpd</span><span class="p">[</span><span class="s1">&#39;attrib&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;OBJS&#39;</span>
                <span class="n">dfUpd</span><span class="p">[</span><span class="s1">&#39;attribValue&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dfUpd</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">~</span><span class="si">{:s}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;TYPE&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                                
                <span class="n">tk</span><span class="o">=</span><span class="n">dfTmp</span><span class="p">[</span><span class="s1">&#39;tk&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dfUpd</span><span class="p">[</span><span class="s1">&#39;xk&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;tk&#39;</span>
                <span class="n">dfUpd</span><span class="p">[</span><span class="s1">&#39;xkValue&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">tk</span>    
                
                <span class="n">dfUpd2</span><span class="o">=</span><span class="n">dfUpd</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;xkValue&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;xkValue&#39;</span><span class="p">:</span> <span class="s1">&#39;first&#39;</span>
                                                    <span class="p">,</span><span class="s1">&#39;table&#39;</span><span class="p">:</span> <span class="s1">&#39;first&#39;</span>
                                                    <span class="p">,</span><span class="s1">&#39;attrib&#39;</span><span class="p">:</span> <span class="s1">&#39;first&#39;</span>
                                                    <span class="p">,</span><span class="s1">&#39;xk&#39;</span><span class="p">:</span> <span class="s1">&#39;first&#39;</span>
                                                    <span class="p">,</span><span class="s1">&#39;attribValue&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
                <span class="n">dfUpd2</span><span class="p">[</span><span class="s1">&#39;attribValue&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dfUpd2</span><span class="p">[</span><span class="s1">&#39;attribValue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
                  
                <span class="n">rowsAffected</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dfUpd2</span><span class="p">)</span>  
                
                <span class="k">return</span> <span class="n">rowsAffected</span>
        
        <span class="k">except</span> <span class="n">DxError</span><span class="p">:</span>
            <span class="k">raise</span>            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logStrFinal</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">Exception: Line: </span><span class="si">{:d}</span><span class="s2">: </span><span class="si">{!s:s}</span><span class="s2">: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span> 
            <span class="k">raise</span> <span class="n">DxError</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>                       
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span><span class="s1">&#39;_Done.&#39;</span><span class="p">))</span>      



<span class="k">def</span> <span class="nf">fHelperSqlText</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.db3&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="o">!=</span> <span class="s1">&#39;.db3&#39;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">text</span>
        <span class="k">return</span> <span class="n">text</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sql</span>


<span class="k">def</span> <span class="nf">fHelper</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">BV</span><span class="p">,</span> <span class="n">BZ</span><span class="p">,</span> <span class="n">dfViewModelle</span><span class="p">,</span> <span class="n">dfCONT</span><span class="p">,</span> <span class="n">pairType</span><span class="p">,</span> <span class="n">ext</span><span class="p">):</span>

    <span class="n">logStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">.</span><span class="si">{1:s}</span><span class="s2">: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
    <span class="c1">#logger.debug(&quot;{0:s}{1:s}&quot;.format(logStr, &#39;Start.&#39;))</span>
    
    <span class="c1"># BV, BZ, BVZ #################</span>

    <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;select * from &#39;</span><span class="o">+</span><span class="n">BV</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dfBV</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">fHelperSqlText</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">ext</span><span class="p">),</span> <span class="n">con</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">pd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">sql: </span><span class="si">{1:s}</span><span class="s2">: Fehler?!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">DxError</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>

    <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;select * from &#39;</span><span class="o">+</span><span class="n">BZ</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dfBZ</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">fHelperSqlText</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">ext</span><span class="p">),</span> <span class="n">con</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">pd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logStrFinal</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">sql: </span><span class="si">{1:s}</span><span class="s2">: Fehler?!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">DxError</span><span class="p">(</span><span class="n">logStrFinal</span><span class="p">)</span>
        

    <span class="c1">#logger.debug(</span>
    <span class="c1">#&quot;{0:s}Quelle BV: {1:s} Quelle BZ: {2:s} BV Zeilen: {3:d} BZ Zeilen: {4:d}&quot;.format(logStr, BV, BZ, dfBV.shape[0], dfBZ.shape[0]))            </span>
        

    <span class="n">dfBVZ</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfBZ</span><span class="p">,</span> <span class="n">dfBV</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fk&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span>
                     <span class="s1">&#39;pk&#39;</span><span class="p">],</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_BZ&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
    
    <span class="c1">#logger.debug(&quot;{0:s}dfBVZ: {1:s}&quot;.format(logStr,dfBVZ.to_string()))    </span>

    <span class="k">if</span> <span class="s1">&#39;tk&#39;</span> <span class="ow">in</span> <span class="n">dfBV</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">():</span>
        <span class="n">dfBVZ_tk</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfBZ</span><span class="p">,</span> <span class="n">dfBV</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fk&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span>
                            <span class="s1">&#39;tk&#39;</span><span class="p">],</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_BZ&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">dfBVZ_tk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dfBVZ</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c1">#logger.debug(&quot;{0:s}BV: {1:s} BZ: {2:s}: BVZ-Resultat mit tk &gt; als mit pk. tk-Resultat wird verwendet.&quot;.format(logStr, BV, BZ))</span>
            <span class="n">dfBVZ</span> <span class="o">=</span> <span class="n">dfBVZ_tk</span>
        <span class="k">elif</span> <span class="n">dfBVZ_tk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">dfBVZ</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="n">dfBVZ</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">pass</span>
        <span class="c1">#logger.debug(&quot;{0:s}BV: {1:s} BZ: {2:s}: BVZ-Resultat LEER ?!&quot;.format(logStr, BV, BZ))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
        <span class="c1">#logger.debug(</span>
        <span class="c1">#&quot;{0:s}BVZ resultierende Zeilen: {1:d}&quot;.format(logStr, dfBVZ.shape[0]))            </span>

    <span class="n">newCols</span> <span class="o">=</span> <span class="n">dfBVZ</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="n">dfBVZ</span> <span class="o">=</span> <span class="n">dfBVZ</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">dfBV</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span>
    <span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">newCols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dfBV</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()])</span>

    <span class="c1"># CONT etc. #############################</span>
    <span class="n">dfBVZ</span> <span class="o">=</span> <span class="n">fHelperCONTetc</span><span class="p">(</span><span class="n">dfBVZ</span><span class="p">,</span> <span class="n">BV</span><span class="p">,</span> <span class="n">BZ</span><span class="p">,</span> <span class="n">dfViewModelle</span><span class="p">,</span> <span class="n">dfCONT</span><span class="p">,</span> <span class="n">pairType</span><span class="p">)</span>
    
    <span class="n">dfBVZ</span><span class="o">=</span><span class="n">dfBVZ</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dfBVZ</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">pass</span>
        <span class="c1">#logger.debug(&quot;{0:s}BV: {1:s} BZ: {2:s}: BVZ-Resultat LEER nach CONT etc?!&quot;.format(logStr, BV, BZ))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
        <span class="c1">#logger.debug(</span>
        <span class="c1">#&quot;{0:s}BVZ resultierende Zeilen nach CONT etc.: {1:d}&quot;.format(logStr, dfBVZ.shape[0]))              </span>
        
    <span class="c1">#logger.debug(&quot;{0:s}{1:s}&quot;.format(logStr, &#39;_Done.&#39;))</span>
    <span class="k">return</span> <span class="n">dfBV</span><span class="p">,</span> <span class="n">dfBZ</span><span class="p">,</span> <span class="n">dfBVZ</span>


<span class="k">def</span> <span class="nf">fHelperCONTetc</span><span class="p">(</span><span class="n">dfBVZ</span><span class="p">,</span> <span class="n">BV</span><span class="p">,</span> <span class="n">BZ</span><span class="p">,</span> <span class="n">dfViewModelle</span><span class="p">,</span> <span class="n">dfCONT</span><span class="p">,</span> <span class="n">pairType</span><span class="p">):</span>

    <span class="n">logStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">.</span><span class="si">{1:s}</span><span class="s2">: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
    <span class="c1">#logger.debug(&quot;{0:s}{1:s}&quot;.format(logStr, &#39;Start.&#39;))</span>

    <span class="c1"># CONT etc. #############################</span>

    <span class="n">cols</span> <span class="o">=</span> <span class="n">dfBVZ</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

    <span class="k">if</span> <span class="s1">&#39;fkDE_BZ&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">dfOrig</span> <span class="o">=</span> <span class="n">dfBVZ</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfBVZ</span><span class="p">,</span> <span class="n">dfViewModelle</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;fkDE_BZ&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;fkBZ&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_VMBZ&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="c1">#logger.debug(&quot;{0:s}{1:s}&quot;.format(</span>
            <span class="c1">#    logStr, &#39;fkDE_BZ ist vmtl. kein BZ-Schluessel, da es sich vmtl. um keine BZ-Eigenschaft handelt sondern um eine BV-Eigenschaft; Spalten werden umbenannt und es wird nach BV-DE gesucht ...&#39;))</span>
            <span class="n">renDct</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_BZ&#39;</span><span class="p">,</span> <span class="s1">&#39;_BV&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span>
            <span class="p">)</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;_BZ$&#39;</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">}</span>
            <span class="n">dfOrig</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">renDct</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;fkDE&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="c1">#logger.debug(&quot;{0:s}{1:s}&quot;.format(</span>
                <span class="c1">#    logStr, &#39;fkDE ist auch in den Spalten ...&#39;))</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfOrig</span><span class="p">,</span> <span class="n">dfViewModelle</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fkDE&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span>
                              <span class="s1">&#39;fkBASIS&#39;</span><span class="p">],</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_VMBASIS&#39;</span><span class="p">),</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dfViewModelle</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fkDE&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span>
                              <span class="s1">&#39;fkVARIANTE&#39;</span><span class="p">],</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_VMVARIANTE&#39;</span><span class="p">),</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:s}{1:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">logStr</span><span class="p">,</span> <span class="s1">&#39;fkDE ist nicht in den Spalten?!&#39;</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;fkDE&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>  
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfBVZ</span><span class="p">,</span> <span class="n">dfViewModelle</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fkDE&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span>
                          <span class="s1">&#39;fkBASIS&#39;</span><span class="p">],</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_VMBASIS&#39;</span><span class="p">),</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dfViewModelle</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fkDE&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span>
                          <span class="s1">&#39;fkVARIANTE&#39;</span><span class="p">],</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_VMVARIANTE&#39;</span><span class="p">),</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">dfBVZ</span>
        
    <span class="k">if</span> <span class="s1">&#39;fkCONT&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">dfTmp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dfCONT</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_CONT&#39;</span><span class="p">),</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fkCONT&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pk_CONT&#39;</span><span class="p">]</span>
                      <span class="c1"># ,suffixes=(&#39;&#39;,&#39;_CONT&#39;)</span>
                      <span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfTmp</span><span class="p">,</span> <span class="n">dfCONT</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_CONT&#39;</span><span class="p">),</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fkCONT&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tk_CONT&#39;</span><span class="p">]</span>  <span class="c1"># !</span>
                          <span class="c1"># ,suffixes=(&#39;&#39;,&#39;_CONT&#39;)</span>
                          <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># pk-Menge ist nicht leer; aber ggf. werden ueber tk mehr/weitere gezogen</span>
            <span class="n">dfTk</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfTmp</span><span class="p">,</span> <span class="n">dfCONT</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_CONT&#39;</span><span class="p">),</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fkCONT&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tk_CONT&#39;</span><span class="p">]</span>  <span class="c1"># !</span>
                            <span class="c1"># ,suffixes=(&#39;&#39;,&#39;_CONT&#39;)</span>
                            <span class="p">)</span>
            <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">rowsTk</span><span class="p">,</span> <span class="n">colsTk</span> <span class="o">=</span> <span class="n">dfTk</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">dfXk</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">dfTk</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
            <span class="n">rowsXk</span><span class="p">,</span> <span class="n">colsXk</span> <span class="o">=</span> <span class="n">dfXk</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="n">rowsXk</span> <span class="o">&gt;</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rowsTk</span> <span class="o">==</span> <span class="n">rowsXk</span><span class="p">:</span>
                    <span class="k">pass</span>
                    <span class="c1">#logger.debug(</span>
                    <span class="c1">#    &quot;{:s}rowsXk: {:d} rowsTk: {:d} rowsPk: {:d} - pk-Menge ist nicht leer; aber tk zieht alle.&quot;.format(logStr, rowsXk, rowsTk, rows))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># tk zieht auch nicht die volle Menge</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">rowsXk: </span><span class="si">{:d}</span><span class="s2"> rowsTk: </span><span class="si">{:d}</span><span class="s2"> rowsPk: </span><span class="si">{:d}</span><span class="s2"> - pk-Menge ist nicht leer; aber ueber tk werden NICHT alle gezogen?!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span> <span class="n">rowsXk</span><span class="p">,</span> <span class="n">rowsTk</span><span class="p">,</span> <span class="n">rows</span><span class="p">))</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">dfXk</span>

    <span class="k">if</span> <span class="n">pairType</span> <span class="o">==</span> <span class="s1">&#39;_ROWT&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;ZEIT&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">():</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lfdNrZEIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="s1">&#39;ZEIT&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">na_position</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span>
                <span class="s1">&#39;pk&#39;</span><span class="p">])[</span><span class="s1">&#39;ZEIT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumcount</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">pairType ROWT: df </span><span class="si">{1:s}</span><span class="s2"> hat keine Spalte ZEIT? Keine Sortierung nach Zeit.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logStr</span><span class="p">,</span><span class="n">BV</span><span class="p">))</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">dfBVZ</span>

    <span class="n">dfBVZ</span> <span class="o">=</span> <span class="n">df</span>

    <span class="c1">#logger.debug(&quot;{0:s}{1:s}&quot;.format(logStr, &#39;_Done.&#39;))</span>
    <span class="k">return</span> <span class="n">dfBVZ</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 1986-2024, 3S Consult GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>